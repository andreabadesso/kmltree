var kmltreeManager=function(){that={};var l=[],i,k={};that.register=function(g,h){if(l.length===0){i=h.opts.gex.pluginInstance;google.earth.addEventListener(i,"balloonopening",e);google.earth.addEventListener(i,"balloonclose",b)}l.push({key:"kmltree-tree-"+l.length.toString(),instance:g,api:h})};that.remove=function(g){for(var h=0;h<l.length;h++)if(l[h].instance===g){l.splice(h,1);break}return g};that.pauseListeners=function(g){google.earth.removeEventListener(i,"balloonopening",e);google.earth.removeEventListener(i,
"balloonclose",b);g();google.earth.addEventListener(i,"balloonopening",e);google.earth.addEventListener(i,"balloonclose",b)};var e=function(g){g=g.getFeature();m(g);console.log("balloonopening")},b=function(){},c=function(g,h){if(g.getUrl()===h)return tree;if(g.getElementByUrl(h))return tree},m=function(g){g=g.getUrl();var h=g.split("#")[0];if(k[h]){console.log("cache hit");return k[h]}else console.log("cache miss",h,g);for(var j=0;j<l.length;j++)if(c(l[j].instance.kmlObject,g)){k[h]=l[j];return l[j]}for(j=
0;j<l.length;j++)for(var s=l[j].api.docs,p=0;p<s.length;p++)if(c(s[p],g)){k[h]=l[j];return l[j]}return false};$(window).bind("message",function(g){g=g.originalEvent;var h=g;console.log("resize");g=i.getBalloon();var j=g.getFeature(),s;if(!(s=!$("#kmltree-balloon-iframe").length))if(!(s=!(h.data.match(/width/)||h.data.match(/unknownIframeDimensions/))))if(!(s=g.getType()!=="GEHtmlDivBalloon")){s=$(g.getContentDiv()).find("iframe")[0];var p;b:for(var t=h.source,z=document.getElementsByTagName("iframe"),
C=0;C<z.length;C++)if(z[0].contentWindow===t){p=z[C];break b}s=s!==p}if(!s){p=m(j);h=JSON.parse(h.data);if(h.unknownIframeDimensions){h=p.api.opts.unknownIframeDimensionsDefault;console.log(h)}s=$("#kmltree-balloon-iframe");g.setMinWidth(h.width);g.setMaxWidth(h.width+h.width*0.1);g.setMinHeight(h.height);g.setMaxHeight(h.height+h.height*0.1);s.height(h.height);s.width(h.width);console.log("set dimensions");$(p.instance).trigger("balloonopen",[g,j])}});return that}(),Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",
encode:function(l){var i="",k,e,b,c,m,g,h=0;for(l=Base64._utf8_encode(l);h<l.length;){k=l.charCodeAt(h++);e=l.charCodeAt(h++);b=l.charCodeAt(h++);c=k>>2;k=(k&3)<<4|e>>4;m=(e&15)<<2|b>>6;g=b&63;if(isNaN(e))m=g=64;else if(isNaN(b))g=64;i=i+this._keyStr.charAt(c)+this._keyStr.charAt(k)+this._keyStr.charAt(m)+this._keyStr.charAt(g)}return i},decode:function(l){var i="",k,e,b,c,m,g=0;for(l=l.replace(/[^A-Za-z0-9\+\/\=]/g,"");g<l.length;){k=this._keyStr.indexOf(l.charAt(g++));e=this._keyStr.indexOf(l.charAt(g++));
c=this._keyStr.indexOf(l.charAt(g++));m=this._keyStr.indexOf(l.charAt(g++));k=k<<2|e>>4;e=(e&15)<<4|c>>2;b=(c&3)<<6|m;i+=String.fromCharCode(k);if(c!=64)i+=String.fromCharCode(e);if(m!=64)i+=String.fromCharCode(b)}return i=Base64._utf8_decode(i)},_utf8_encode:function(l){l=l.replace(/\r\n/g,"\n");for(var i="",k=0;k<l.length;k++){var e=l.charCodeAt(k);if(e<128)i+=String.fromCharCode(e);else{if(e>127&&e<2048)i+=String.fromCharCode(e>>6|192);else{i+=String.fromCharCode(e>>12|224);i+=String.fromCharCode(e>>
6&63|128)}i+=String.fromCharCode(e&63|128)}}return i},_utf8_decode:function(l){for(var i="",k=0,e=c1=c2=0;k<l.length;){e=l.charCodeAt(k);if(e<128){i+=String.fromCharCode(e);k++}else if(e>191&&e<224){c2=l.charCodeAt(k+1);i+=String.fromCharCode((e&31)<<6|c2&63);k+=2}else{c2=l.charCodeAt(k+1);c3=l.charCodeAt(k+2);i+=String.fromCharCode((e&15)<<12|(c2&63)<<6|c3&63);k+=3}}return i}};
(function(){var l={};this.tmpl=function i(k,e){var b=!/\W/.test(k)?l[k]=l[k]||i(document.getElementById(k).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+k.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return e?b(e):b}})();
kmldom=function(){return function(l){if(window.ActiveXObject&&window.GetObject){var i=new ActiveXObject("Microsoft.XMLDOM");i.loadXML(l);return jQuery(i)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(l,"text/xml"));throw Error("No XML parser available");}}();var URI,URIQuery;
(function(){function l(e,b){var c=/^(.*)\//;return e.authority&&!e.path?"/"+b:e.getPath().match(c)[0]+b}function i(e){if(!e)return"";e=e.replace(/\/\.\//g,"/");for(e=e.replace(/\/\.$/,"/");e.match(k);)e=e.replace(k,"/");for(e=e.replace(/\/([^\/]*)\/\.\.$/,"/");e.match(/\/\.\.\//);)e=e.replace(/\/\.\.\//,"/");return e}var k=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(e){e||(e="");e=e.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);var b=e[1]||null,c=e[2]||null,m=
e[3]||null,g=e[4]||null,h=e[5]||null;this.getScheme=function(){return b};this.setScheme=function(j){b=j};this.getAuthority=function(){return c};this.setAuthority=function(j){c=j};this.getPath=function(){return m};this.setPath=function(j){m=j};this.getQuery=function(){return g};this.setQuery=function(j){g=j};this.getFragment=function(){return h};this.setFragment=function(j){h=j}};URI.prototype.toString=function(){var e="";if(this.getScheme())e+=this.getScheme()+":";if(this.getAuthority())e+="//"+this.getAuthority();
if(this.getPath())e+=this.getPath();if(this.getQuery())e+="?"+this.getQuery();if(this.getFragment())e+="#"+this.getFragment();return e};URI.prototype.resolve=function(e){var b=new URI;if(this.getScheme()){b.setScheme(this.getScheme());b.setAuthority(this.getAuthority());b.setPath(i(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getAuthority()){b.setAuthority(this.getAuthority());b.setPath(i(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getPath()){if(this.getPath().charAt(0)===
"/")b.setPath(i(this.getPath()));else{b.setPath(l(e,this.getPath()));b.setPath(i(b.getPath()))}b.setQuery(this.getQuery())}else{b.setPath(e.getPath());this.getQuery()?b.setQuery(this.getQuery()):b.setQuery(e.getQuery())}b.setAuthority(e.getAuthority())}b.setScheme(e.getScheme())}b.setFragment(this.getFragment());return b};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(e,
b){var c=new URIQuery;if(b)c.separator=b;c.addStringParams(e);return c};URIQuery.prototype.addStringParams=function(e){e=e.split(this.separator);for(var b,c,m=0;m<e.length;m++){b=e[m].split("=",2);c=b[0].replace(/\+/g," ");b=b[1].replace(/\+/g," ");this.params.hasOwnProperty(c)||(this.params[c]=[]);this.params[c].push(b)}};URIQuery.prototype.getParam=function(e){if(this.params.hasOwnProperty(e))return this.params[e][0];return null};URIQuery.prototype.toString=function(){var e=[],b;b=this.params;var c=
[],m;for(m in b)b.hasOwnProperty(m)&&c.push(m);b=c.sort();for(c=0;c<b.length;c++)for(m=0;m<this.params[b[c]].length;m++)e.push(b[c].replace(/ /g,"+")+"="+this.params[b[c]][m].replace(/ /g,"+"));return e.join(this.separator)}})();
var kmltree=function(){function l(b){var c=document.createElement("a");c.href=b;return c.href}openBalloon=function(b,c,m,g){var h;if(m.displayEnhancedContent){var j=b.getBalloonHtmlUnsafe();h=b.getBalloonHtml();h=$.trim(h.replace(/\s*<\!--\s*Content-type: mhtml-die-die-die\s*--\>/,""));h=h!=$.trim(j)}if(m.displayEnhancedContent&&h){h=c.createHtmlDivBalloon("");var s=$(['<iframe id="kmltree-balloon-iframe" border="0" frameBorder="0" src="',m.iframeSandbox,'"></iframe>'].join("")),p=document.createElement("div");
$(p).append(s);s.load(function(){this.contentWindow.postMessage(JSON.stringify({html:Base64.encode(j),callback:Base64.encode(m.sandboxedBalloonCallback.toString())}),"*")});h.setContentDiv(p)}else{h=c.createFeatureBalloon("");var t=function(z){setTimeout(function(){$(g).trigger("balloonopen",[z.getBalloon(),z.getFeature()])},1);google.earth.removeEventListener(c,"balloonopening",t)};google.earth.addEventListener(c,"balloonopening",t)}h.setFeature(b);c.setBalloon(h);setTimeout(function(){window.kmltreeAlreadyGotItMkay=
false},1)};var i=function(b){if(b.success&&b.error&&b.tree){this.queue=[];this.opts=b}else throw"missing required option";};i.prototype.add=function(b,c){this.queue.push({node:b,callback:c,loaded:false,errors:false})};i.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var b=0;b<this.queue.length;b++){var c=this.queue[b];c.node.data("queueItem",c);if(!c.loaded&&!c.loading){var m=this;$(c.node).bind("loaded",function(g,h,j){m.nodeLoadedCallback(g,h,j)});this.opts.tree.openNetworkLink(c.node);
c.loading=true}}};i.prototype.nodeLoadedCallback=function(b,c){var m=c.data("queueItem");if(m.loaded===true)throw"event listener fired twice for "+c.find(">span.name").text();m.loaded=true;m.loading=false;$(c).unbind("loaded");m.callback(c);this.execute();this.finish(m)};i.prototype.finish=function(){for(var b=true,c=true,m=0;m<this.queue.length;m++){b=b&&this.queue[m].loaded;c=c&&!this.queue[m].errors}if(b){c?this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};i.prototype.destroy=
function(){for(var b=0;b<this.queue.length;b++)this.queue[b].node.unbind("load");this.queue=[]};var k=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
e={visitFunction:function(b,c){return c},refreshWithState:true,bustCache:false,restoreState:false,whitelist:[],supportItemIcon:false,loadingMsg:"Loading data",setExtent:false,displayDocumentRoot:"auto",displayEnhancedContent:false,iframeSandbox:"http://underbluewaters-try-unsafe-popups.googlecode.com/hg/src/iframe.html",unknownIframeDimensionsDefault:{height:450,width:530},sandboxedBalloonCallback:function(){}};return function(b){var c={},m=0,g={};c.lookupTable=g;c.kmlObject=null;var h=[];b=jQuery.extend({},
e,b);var j=b.gex.pluginInstance,s=false,p={};parseFloat(j.getPluginVersion())<5.2&&alert("kmltree requires a google earth plugin version >= 5.2");if(!b.url||!b.gex||!b.element||!b.mapElement)throw"kmltree requires options url, gex, mapElement & element";b.element=$(b.element);if(!b.element.attr("id")){b.element.attr("id","kml-tree"+(new Date).getTime());b.element.attr("UNSELECTABLE","on")}b.restoreState&&$(window).unload(function(){c.destroy()});b.element.css("position")!=="absolute"&&$(b.element).css({position:"relative"});
var t=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),z=t[0].style.backgroundSize!==undefined||t[0].style.MozBackgroundSize!==undefined||t[0].style.oBackgroundSize!==undefined||t[0].style.khtmlBackgroundSize!==undefined||t[0].style.webkitBackgroundSize!==undefined,C=function(a,d,f){var n={name:a.getName(),id:"kml"+(f?f.replace(/\W/g,"-"):"")+d.replace(/\W/g,
"-")};google.earth.executeBatch(j,function(){b.gex.dom.walk({visitCallback:function(o){var r=o.current;if(!r.children)r.children=[];var u=this.getName(),q;q=r.id;key=u?u.replace(/\W/g,"-"):"blank";q+=key;for(var v=0;g[q];){v++;q+=v}g[q]=this;var H=this.getSnippet();if(!H||H==="empty")H=false;v=this.getType();var S=false;if(v==="KmlPlacemark"){var I=this.getGeometry();if(I)S=I.getType()}var E=this.getComputedStyle();u=u||"&nbsp;";I=!!this.getVisibility();var ca=this.getOpen(),da=this.getDescription(),
x="check";if(E=E.getListStyle())switch(E.getListItemType()){case 5:x="radioFolder";break;case 2:x="checkOffOnly";break;case 3:x="checkHideChildren"}E=x;x=false;if(z&&this.getType()==="KmlPlacemark"&&this.getGeometry()&&this.getGeometry().getType()==="KmlPoint")x=this.getComputedStyle().getIconStyle().getIcon().getHref();if(b.supportItemIcon)x=(x=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?x:false;q={renderOptions:J,
name:u,visible:I,type:v,open:ca,id:q,description:da,snippet:H,select:false,listItemType:E,customIcon:x,customClass:"",children:[],alwaysRenderNodes:false,kmlId:this.getId().replace(/\W/g,"-"),geoType:S};q=b.visitFunction(this,q);r.children.push(q);if(q.listItemType!=="checkHideChildren")o.child=q;else o.walkChildren=false},rootObject:a,rootContext:n})});return n},V=function(a){if(c.kmlObject)throw"KML already loaded";T();var d=l(b.url);if(a||b.bustCache){a=(new Date).getTime();d=d.indexOf("?")===
-1?d+"?cachebuster="+a:d+"&cachebuster="+a}google.earth.fetchKml(j,d,function(f){s||U(f,d,b.url)})};c.load=V;c.refresh=function(){if(b.refreshWithState)c.previousState=M();W();g=null;g={};j.setBalloon(null);V(true)};var N=function(a){return b.element.find("."+a.replace(/\W/g,"-"))};c.getNodesById=N;c.selectById=function(a){a=N(a)[0];return O(a,w(a))};var B=function(a,d){var f=$("#"+b.element.attr("id")).find(".selected").removeClass("selected");if(f.length){f.each(function(){y($(this),"selected",
false)});d||$(c).trigger("select",[null,null])}j.getBalloon()&&!a&&j.setBalloon(null)};c.clearSelection=function(){return B()};var T=function(a){K();a=a||b.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var d=b.element.height();d!==0&&a.height(d);b.element.append(a)};c.showLoading=T;var K=function(){b.element.find(".kmltree-loading").remove()};c.hideLoading=K;var U=function(a,d,f){p={};if(a){m=0;c.kmlObject=a;h.push(a);c.kmlObject.setVisibility(true);var n=C(a,f),o;if(b.displayDocumentRoot===
false)o=n.children[0].children;else if(b.displayDocumentRoot===true)o=n.children[0];else{o=n.children[0].children;for(var r=0,u=false;r<o.length&&u===false;){u=o[r].type==="KmlPlacemark";r++}o=u?n.children[0]:n.children[0].children}o=J(o);b.element.find("div.kmltree").remove();b.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',n.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',o,"</ul></div>"].join(""));j.getFeatures().appendChild(a);
if(!c.previousState)if(b.restoreState&&window.localStorage)c.previousState=ea();n=new i({success:function(){K();if(b.setExtent){var q=null,v=$(b.mapElement);if(v.length)q=v.width()/v.height();b.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:q});b.setExtent=false}$(c).trigger("kmlLoaded",[a])},error:function(){K();$(c).trigger("kmlLoadError",[a])},tree:c});c.previousState?X(c.previousState,n):P(n,$("#"+b.element.attr("id")))}else if(m===0){m++;setTimeout(function(){jQuery.ajax({url:d,success:function(){c.load(true)},
error:function(){U(a,d,f)}})},100)}else setTimeout(function(){b.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',d,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(c).trigger("kmlLoadError",[a])},0)},X=function(a,d){for(var f in a){var n=$("#"+f);if(n.length===1){for(var o in a[f]){n.toggleClass(o,a[f][o].value);y(n,o,a[f][o].value);o==="visible"&&w(n).setVisibility(a[f][o].value)}delete a[f]}}$("#"+
b.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var r=$(this);!r.hasClass("checkHideChildren")&&!r.hasClass("loading")&&!r.hasClass("loaded")&&!r.hasClass("error")&&d.add(r,function(){X(a,d)})});d.execute()},P=function(a,d){d.find("li.KmlNetworkLink.open").each(function(){var f=$(this);if(!f.hasClass("checkHideChildren")&&!f.hasClass("loading")&&!f.hasClass("loaded")){f.removeClass("open");a.add(f,function(n){n.addClass("open");y(n,"open",f.hasClass("open"));P(a,n)})}});a.execute()},
J=function(a){if(jQuery.isArray(a)){for(var d=[],f=0;f<a.length;f++)d.push(k(jQuery.extend({},Y,a[f])));return d.join("")}else return k(jQuery.extend({},Y,a))},Y={renderOptions:J},fa=function(){$(".KmlNetworkLink").each(function(){var a=w($(this));a&&a.getParentNode()&&b.gex.dom.removeObject(w($(this)))})},W=function(){fa();c.kmlObject&&c.kmlObject.getParentNode()&&b.gex.dom.removeObject(c.kmlObject);c.kmlObject=null;h=[]},ea=function(){var a=localStorage.getItem("kmltree-("+b.url+")");return a?JSON.parse(a):
false};c.destroy=function(){s=true;kmltreeManager.remove(c);if(b.restoreState&&window.localStorage){var a=JSON.stringify(M());localStorage.setItem("kmltree-("+b.url+")",a)}W();g=null;g={};a=b.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();b.element.html("");google.earth.removeEventListener(j,"balloonopening",D);google.earth.removeEventListener(j,"balloonclose",Z);$("#kmltree-balloon-iframe").remove()};var w=function(a){a=$(a);return a.length?
g[a.attr("id")]:false};c.lookup=w;var O=function(a,d){d||(d=w(a));a=$(a);B(true,true);a.addClass("selected");F(a,true);a.addClass("selected");google.earth.removeEventListener(j,"balloonopening",D);openBalloon(d,j,b,c);google.earth.addEventListener(j,"balloonopening",D);for(var f=a.parent().parent();!f.hasClass("kmltree")&&!f.find(">ul:visible").length;){f.addClass("open");f=f.parent().parent()}y(a,"selected",true);$(c).trigger("select",[a,d])};c.selectNode=O;var G=function(a,d){if(d){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){var f=
a.find(">ul>li");if(f.length){A($(f[0]),true);G($(f[0]),true)}}}else a.find(">ul>li").each(function(){var n=$(this);if(!n.hasClass("checkOffOnly")){A(n,true);G(n,true)}})}else a.find("li").each(function(){A($(this),false)})},Q=function(a,d){var f=a.parent().parent();if(!f.hasClass("kmltree"))if(d){var n=f.parent().parent();n.hasClass("radioFolder")&&n.find(">ul>li.visible").each(function(){if(this!==f[0]){var o=$(this);A(o,false);G(o,false)}});if(!f.hasClass("visible")){A(f,true);Q(f,true)}}else if(f.find(">ul>li.visible").length===
0){A(f,false);Q(f,false)}},F=function(a,d){if(!(a.hasClass("checkOffOnly")&&d)){var f=a.parent().parent();f.hasClass("radioFolder")&&f.find(">ul>li.visible").each(function(){A($(this),false);G($(this),false)});A(a,d);d&&a.find("li.visible").length||G(a,d);Q(a,d)}},A=function(a,d){a=$(a);if(a.hasClass("visible")!==d){y(a,"visible",d);w(a).setVisibility(d);a.toggleClass("visible",d)}},y=function(a,d,f){a=a.attr("id");p[a]||(p[a]={});a=p[a];if(a[d])a[d].value=f;else a[d]={original:!f,value:f}},M=function(){for(var a in p){for(var d in p[a])p[a][d].original===
p[a][d].value&&delete p[a][d];var f=0;for(d in p[a])p[a].hasOwnProperty(d)&&f++;f===0&&delete p[a]}return p};c.getState=M;c.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var d=w(a),f=d.getLink();if(f)var n=f=f.getHref();else{var o=kmldom(d.getKml()).find("Url>href");if(o.length)n=f=o.text();else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");y(a,"open",false);return}}o=new URI(f);if(o.getAuthority()===null){var r=d.getOwnerDocument();
if(r&&r.getUrl)if(r=r.getUrl()){r=new URI(r);var u=o.resolve(r)}if(u)f=u.toString();else alert(["Could not resolve relative link in kml ","document. You may need to upgrade to the ","latest Google Earth Plugin."].join())}if(b.bustCache){u=(new Date).getTime();f=f.indexOf("?")===-1?f+"?cachebuster="+u:f+"&cachebuster="+u}a.addClass("loading");google.earth.fetchKml(j,f,function(q){if(q){j.getFeatures().appendChild(q);q.setVisibility(d.getVisibility());var v=d.getName();d.getParentNode().getFeatures().removeChild(d);
v=C(q,n,v);v=J(v.children[0].children);a.append("<ul>"+v+"</ul>");a.addClass("open");y(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");g[a.attr("id")]=q;h.push(q);$(a).attr("data-rememberedLink",L.length.toString());L.push(d);$(a).trigger("loaded",[a,q]);$(c).trigger("networklinkload",[a,q])}else{alert("Error loading "+f);a.addClass("error");$(c).trigger("kmlLoadError",[q]);a.removeClass("open")}})}};var L=[];c.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&
L.length>=a?L[a]:false};var aa=function(a){var d=new i({success:function(){},error:function(){},tree:c});d.add(a,function(f){f.addClass("open");y(f,"open",a.hasClass("open"));P(d,f)});d.execute()};t=b.element.attr("id");$("#"+t+" li > span.name").live("click",function(a){a.stopPropagation();a=$(this).parent();var d=w(a);if(a.hasClass("error")&&a.hasClass("KmlNetworkLink"))d.getLink()&&d.getLink().getHref()?alert("Could not load NetworkLink with url "+d.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");
if(a.hasClass("select"))O(a,d);else{B();if(a.hasClass("hasDescription")||d.getType()==="KmlPlacemark"){d.getType()==="KmlPlacemark"&&F(a,true);google.earth.removeEventListener(j,"balloonopening",D);openBalloon(d,j,b,c);google.earth.addEventListener(j,"balloonopening",D)}}$(c).trigger("click",[a[0],d])});$("#"+t+" li > span.name").live("contextmenu",function(){var a=$(this).parent(),d=w(a);$(c).trigger("contextmenu",[a[0],d])});b.element.click(function(a){if(a.target===this)B();else{a=$(a.target);
a.hasClass("toggle")&&!a.hasClass("select")&&B()}});$("#"+t+" li > .expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))aa(a);else{a.toggleClass("open");y(a,"open",a.hasClass("open"))}});$("#"+t+" li > .toggler").live("click",function(){var a=$(this).parent(),d=!a.hasClass("visible");!d&&a.hasClass("selected")&&B();!d&&j.getBalloon()&&j.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&d)){if(a.hasClass("KmlNetworkLink")&&
a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){aa(a);$(a).bind("loaded",function(f,n){F(n,true);n.removeClass("open")})}else F(a,d);$(c).trigger("toggleItem",[a,d,w(a)])}});$("#"+t+" li").live("dblclick",function(a){a.stopPropagation();var d=$(a.target);a=d.parent();if(!(d.hasClass("expander")||d.hasClass("toggler")||a.hasClass("expander")||a.hasClass("toggler"))){d=$(this);var f=w(d);if(d.hasClass("error"))f.getLink()&&f.getLink().getHref()?alert("Could not load NetworkLink with url "+
f.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{F(d,true);if(f.getType()=="KmlTour")j.getTourPlayer().setTour(f);else{var n=null,o=$(b.mapElement);if(o.length)n=o.width()/o.height();b.gex.util.flyToObject(f,{boundsFallback:a.find("li").length<1E3,aspectRatio:n})}$(c).trigger("dblclick",[d,f])}}});t=google.earth.addEventListener;var D=function(a){if(window.kmltreeAlreadyGotItMkay)console.log("somebody already has it",window.kmltreeAlreadyGotItMkay);else{var d=
a.getFeature();if(ba(d)){window.kmltreeAlreadyGotItMkay=c;a.preventDefault();a.stopPropagation();j.setBalloon(null);openBalloon(d,j,b,c);return false}}};google.earth.addEventListener(j,"balloonopening",D);var Z=function(){$("#kmltree-balloon-iframe").remove();B()};t(j,"balloonclose",Z);var R=false;t(j.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var d=a.getTarget();if(d.getType()!=="GEGlobe")if(d.getType()==="KmlPlacemark"){a=d.getId();var f=N(a);if(f.length>=1)if(!R){R=true;setTimeout(function(){R=
false;var n=$(f[0]);$(c).trigger("dblclick",[n,d])},200)}}}});var ba=function(a){var d=a.getOwnerDocument();if(!d)for(;a.getType()!=="GEGlobe";){d=a;a=a.getParentNode()}for(a=0;a<h.length;a++)if(h[a].getUrl()===d.getUrl())return true;return false};c.ownsFeature=ba;c.removeEventListener=c.detachEvent=function(){};kmltreeManager.register(c,{opts:b,docs:h});return c}}(),enableGoogleLayersControl=function(){var l=function(i,k,e){if((i=i.getId())&&i.match(/^LAYER/))e.getLayerRoot().enableLayerById(e[i],
k);else{var b=e.getOptions();switch(i){case "SUN":e.getSun().setVisibility(k);break;case "NAVIGATION_CONTROLS":i=e.VISIBILITY_SHOW;if(!k)i=e.VISIBILITY_HIDE;e.getNavigationControl().setVisibility(i);break;case "STATUS_BAR":b.setStatusBarVisibility(k);break;case "OVERVIEW_MAP":b.setOverviewMapVisibility(k);break;case "SCALE_LEGEND":b.setScaleLegendVisibility(k);break;case "ATMOSPHERE":b.setAtmosphereVisibility(k);break;case "HISTORICAL_IMAGERY":e.getTime().setHistoricalImageryEnabled(k);break;case "GRID":b.setGridVisibility(k)}}};
return function(i,k){if(!i||!k)alert("Must call enableGoogleLayersControl with both tree and ge options!");$(i).bind("toggleItem",function(e,b,c,m){l(m,c,k)});$(i).bind("kmlLoaded",function(e,b){for(var c=b.getFeatures().getChildNodes(),m=c.getLength(),g=0;g<m;g++){var h=c.item(g);l(h,h.getVisibility(),k)}})}}();
