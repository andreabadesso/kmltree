(function(){var v={};this.tmpl=function n(s,A){var c=!/\W/.test(s)?(v[s]=v[s]||n(document.getElementById(s).innerHTML)):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+s.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return A?c(A):c}})();
kmldom=function(){return function(v){if(window.ActiveXObject&&window.GetObject){var n=new ActiveXObject("Microsoft.XMLDOM");n.loadXML(v);return jQuery(n)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(v,"text/xml"));throw new Error("No XML parser available");}}();
var kmltree=function(){function v(c){var e=document.createElement("a");e.href=c;return e.href}openBalloon=function(c,e){var h=e.createFeatureBalloon("");h.setFeature(c);h.setMinWidth(100);e.setBalloon(h)};var n=function(c){if(c.success&&c.error&&c.tree){this.queue=[];this.opts=c}else throw"missing required option";};n.prototype.add=function(c,e){this.queue.push({node:c,callback:e,loaded:false,errors:false})};n.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var c=
0;c<this.queue.length;c++){var e=this.queue[c];e.node.data("queueItem",e);if(!e.loaded&&!e.loading){var h=this;$(e.node).bind("loaded",function(q,j,B){h.nodeLoadedCallback(q,j,B)});this.opts.tree.openNetworkLink(e.node);e.loading=true}}};n.prototype.nodeLoadedCallback=function(c,e){var h=e.data("queueItem");if(h.loaded===true)throw"event listener fired twice for "+e.find(">span.name").text();h.loaded=true;h.loading=false;$(e).unbind("loaded");h.callback(e);this.execute();this.finish(h)};n.prototype.finish=
function(){for(var c=true,e=true,h=0;h<this.queue.length;h++){c=c&&this.queue[h].loaded;e=e&&!this.queue[h].errors}if(c){e?this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};n.prototype.destroy=function(){for(var c=0;c<this.queue.length;c++)this.queue[c].node.unbind("load");this.queue=[]};var s=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon">&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
A={enableSelection:function(){return false},visitFunction:function(c,e){return e},refreshWithState:true,bustCache:false,restoreState:false,supportItemIcon:false,loadingMsg:"Loading data",setExtent:false};return function(c){var e={},h=0,q={};e.lookupTable=q;e.kmlObject=null;c=jQuery.extend({},A,c);var j=c.gex.pluginInstance,B=false,m={};if(parseFloat(j.getPluginVersion())<5.2)throw"kmltree requires a google earth plugin version >= 5.2";if(!c.url||!c.gex||!c.element||!c.mapElement)throw"kmltree requires options url, gex, mapElement & element";
c.element=$(c.element);if(!c.element.attr("id")){c.element.attr("id","kml-tree"+(new Date).getTime());c.element.attr("UNSELECTABLE","on")}c.restoreState&&$(window).unload(function(){e.destroy()});c.element.css("position")!=="absolute"&&$(c.element).css({position:"relative"});var l=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),S=l[0].style.backgroundSize!==
undefined||l[0].style.MozBackgroundSize!==undefined||l[0].style.oBackgroundSize!==undefined||l[0].style.khtmlBackgroundSize!==undefined||l[0].style.webkitBackgroundSize!==undefined,K=function(a,b){var d={name:a.getName(),id:"kml"+b.replace(/\W/g,"-")};google.earth.executeBatch(j,function(){c.gex.dom.walk({visitCallback:function(f){var k=f.current;if(!k.children)k.children=[];var g=this.getName(),i;i=k.id;key=g?g.replace(/\W/g,"-"):"blank";i=i+key;if(q[i])throw"attempting to add lookup that already exists!";
q[i]=this;var w=this.getSnippet();if(!w||w==="empty")w=false;var x=this.getComputedStyle();g=g||"&nbsp;";var T=!!this.getVisibility(),U=this.getType(),V=this.getOpen(),W=this.getDescription();w=w;var X=c.enableSelection(this),o="check";if(x=x.getListStyle())switch(x.getListItemType()){case 0:break;case 5:o="radioFolder";break;case 2:o="checkOffOnly";break;case 3:o="checkHideChildren";break}x=o;o=false;if(S&&this.getType()==="KmlPlacemark"&&this.getGeometry()&&this.getGeometry().getType()==="KmlPoint")o=
this.getComputedStyle().getIconStyle().getIcon().getHref();if(c.supportItemIcon)o=(o=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?o:false;else o=o;i={renderOptions:C,name:g,visible:T,type:U,open:V,id:i,description:W,snippet:w,select:X,listItemType:x,customIcon:o,customClass:"",children:[],alwaysRenderNodes:false,kmlId:this.getId().replace(/\W/g,"-")};i=c.visitFunction(this,i);k.children.push(i);if(i.listItemType!==
"checkHideChildren")f.child=i;else f.walkChildren=false},rootObject:a,rootContext:d})});return d},N=function(a){if(e.kmlObject)throw"KML already loaded";L();var b=v(c.url);if(a||c.bustCache){a=(new Date).getTime();b=b.indexOf("?")===-1?b+"?cachebuster="+a:b+"&cachebuster="+a}google.earth.fetchKml(j,b,function(d){B||M(d,b,c.url)})};e.load=N;e.refresh=function(){if(c.refreshWithState)e.previousState=G();O();q=null;q={};j.setBalloon(null);N(true)};var D=function(a){return c.element.find("."+a.replace(/\W/g,
"-"))};e.getNodesById=D;e.selectById=function(a){a=D(a)[0];return E(a,p(a))};var t=function(a,b){var d=$("#"+c.element.attr("id")).find(".selected").removeClass("selected");if(d.length){d.each(function(){r($(this),"selected",false)});b||$(e).trigger("select",[null,null])}j.getBalloon()&&!a&&j.setBalloon(null)};e.clearSelection=function(){return t()};var L=function(a){F();a=a||c.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var b=c.element.height();b!==0&&a.height(b);c.element.append(a)};
e.showLoading=L;var F=function(){c.element.find(".kmltree-loading").remove()};e.hideLoading=F;var M=function(a,b,d){m={};if(a){h=0;e.kmlObject=a;e.kmlObject.setVisibility(true);var f=K(a,d),k=C(f.children[0].children);c.element.find("div.kmltree").remove();c.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',f.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',k,"</ul></div>"].join(""));j.getFeatures().appendChild(a);
if(!e.previousState)if(c.restoreState&&window.localStorage)e.previousState=Y();f=new n({success:function(){F();if(c.setExtent){var g=null,i=$(c.mapElement);if(i.length)g=i.width()/i.height();c.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:g});c.setExtent=false}$(e).trigger("kmlLoaded",[a])},error:function(){F();$(e).trigger("kmlLoadError",[a])},tree:e});e.previousState?P(e.previousState,f):H(f,$("#"+c.element.attr("id")))}else if(h===0){h++;setTimeout(function(){jQuery.ajax({url:b,success:function(){e.load(true)},
error:function(){M(a,b,d)}})},100)}else setTimeout(function(){c.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',b,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(e).trigger("kmlLoadError",[a])},0)},P=function(a,b){for(var d in a){var f=$("#"+d);if(f.length===1){for(var k in a[d]){f.toggleClass(k,a[d][k].value);r(f,k,a[d][k].value);k==="visible"&&p(f).setVisibility(a[d][k].value)}delete a[d]}}$("#"+
c.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var g=$(this);!g.hasClass("checkHideChildren")&&!g.hasClass("loading")&&!g.hasClass("loaded")&&!g.hasClass("error")&&b.add(g,function(){P(a,b)})});b.execute()},H=function(a,b){b.find("li.KmlNetworkLink.open").each(function(){var d=$(this);if(!d.hasClass("checkHideChildren")&&!d.hasClass("loading")&&!d.hasClass("loaded")){d.removeClass("open");a.add(d,function(f){f.addClass("open");r(f,"open",d.hasClass("open"));H(a,f)})}});a.execute()},
C=function(a){if(jQuery.isArray(a)){for(var b=[],d=0;d<a.length;d++)b.push(s(jQuery.extend({},Q,a[d])));return b.join("")}else return s(jQuery.extend({},Q,a))},Q={renderOptions:C},Z=function(){$(".KmlNetworkLink").each(function(){p($(this)).getParentNode()&&c.gex.dom.removeObject(p($(this)))})},O=function(){Z();e.kmlObject&&e.kmlObject.getParentNode()&&c.gex.dom.removeObject(e.kmlObject);e.kmlObject=null},Y=function(){var a=localStorage.getItem("kmltree-("+c.url+")");return a?JSON.parse(a):false};
e.destroy=function(){B=true;if(c.restoreState&&window.localStorage){var a=JSON.stringify(G());localStorage.setItem("kmltree-("+c.url+")",a)}O();q=null;q={};a=c.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();c.element.html("")};var p=function(a){a=$(a);return a.length?q[a.attr("id")]:false};e.lookup=p;var E=function(a,b){b||(b=p(a));a=$(a);t(true,true);a.addClass("selected");y(a,true);a.addClass("selected");openBalloon(b,j);for(var d=a.parent().parent();!d.hasClass("kmltree")&&
!d.find(">ul:visible").length;){d.addClass("open");d=d.parent().parent()}r(a,"selected",true);$(e).trigger("select",[a,b])};e.selectNode=E;var z=function(a,b){if(b){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){var d=a.find(">ul>li");if(d.length){u($(d[0]),true);z($(d[0]),true)}}}else a.find(">ul>li").each(function(){var f=$(this);if(!f.hasClass("checkOffOnly")){u(f,true);z(f,true)}})}else a.find("li").each(function(){u($(this),false)})},I=function(a,
b){var d=a.parent().parent();if(!d.hasClass("kmltree"))if(b){var f=d.parent().parent();f.hasClass("radioFolder")&&f.find(">ul>li.visible").each(function(){if(this!==d[0]){var k=$(this);u(k,false);z(k,false)}});if(!d.hasClass("visible")){u(d,true);I(d,true)}}else if(d.find(">ul>li.visible").length===0){u(d,false);I(d,false)}},y=function(a,b){if(!(a.hasClass("checkOffOnly")&&b)){var d=a.parent().parent();d.hasClass("radioFolder")&&d.find(">ul>li.visible").each(function(){u($(this),false);z($(this),
false)});u(a,b);z(a,b);I(a,b)}},u=function(a,b){a=$(a);if(a.hasClass("visible")!==b){r(a,"visible",b);p(a).setVisibility(b);a.toggleClass("visible",b)}},r=function(a,b,d){a=a.attr("id");m[a]||(m[a]={});a=m[a];if(a[b])a[b].value=d;else a[b]={original:!d,value:d}},G=function(){for(var a in m){for(var b in m[a])m[a][b].original===m[a][b].value&&delete m[a][b];var d=0;for(b in m[a])m[a].hasOwnProperty(b)&&d++;d===0&&delete m[a]}return m};e.getState=G;e.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";
else{var b=p(a),d=b.getLink();if(d){var f=d=d.getHref();if(c.bustCache){var k=(new Date).getTime();d=d.indexOf("?")===-1?d+"?cachebuster="+k:d+"&cachebuster="+k}a.addClass("loading");google.earth.fetchKml(j,d,function(g){if(g){j.getFeatures().appendChild(g);g.setVisibility(b.getVisibility());b.getParentNode().getFeatures().removeChild(b);var i=K(g,f);i=C(i.children[0].children);a.append("<ul>"+i+"</ul>");a.addClass("open");r(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");
q[a.attr("id")]=g;$(a).trigger("loaded",[a,g]);$(e).trigger("networklinkload",[a,g])}else{alert("Error loading "+d);a.addClass("error");$(e).trigger("kmlLoadError",[g]);a.removeClass("open")}})}else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");r(a,"open",false)}}};var R=function(a){var b=new n({success:function(){},error:function(){},tree:e});b.add(a,function(d){d.addClass("open");r(d,"open",a.hasClass("open"));H(b,d)});b.execute()};l=c.element.attr("id");$("#"+l+" li > span.name").live("click",
function(){var a=$(this).parent(),b=p(a);if(a.hasClass("error")&&a.hasClass("KmlNetworkLink"))b.getLink()&&b.getLink().getHref()?alert("Could not load NetworkLink with url "+b.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");if(a.hasClass("select"))E(a,b);else{t();if(a.hasClass("hasDescription")||b.getType()==="KmlPlacemark"){b.getType()==="KmlPlacemark"&&y(a,true);openBalloon(b,j,c.whiteListed)}}$(e).trigger("click",[a[0],b])});$("#"+l+" li > span.name").live("contextmenu",
function(){var a=$(this).parent(),b=p(a);$(e).trigger("contextmenu",[a[0],b])});c.element.click(function(a){if(a.target===this)t();else{a=$(a.target);a.hasClass("toggle")&&!a.hasClass("select")&&t()}});$("#"+l+" li > .expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))R(a);else{a.toggleClass("open");r(a,"open",a.hasClass("open"))}});$("#"+l+" li > .toggler").live("click",function(){var a=$(this).parent(),b=!a.hasClass("visible");
!b&&a.hasClass("selected")&&t();!b&&j.getBalloon()&&j.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&b)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){R(a);$(a).bind("loaded",function(d,f){y(f,true);f.removeClass("open")})}else y(a,b);$(e).trigger("toggleItem",[a,b])}});$("#"+l+" li").live("dblclick",function(a){console.log("dblclick");a=$(a.target);var b=a.parent();if(!(a.hasClass("expander")||a.hasClass("toggler")||
b.hasClass("expander")||b.hasClass("toggler"))){a=$(this);b=p(a);if(a.hasClass("error"))b.getLink()&&b.getLink().getHref()?alert("Could not load NetworkLink with url "+b.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{y(a,true);if(b.getType()=="KmlTour")j.getTourPlayer().setTour(b);else{var d=null,f=$(c.mapElement);if(f.length)d=f.width()/f.height();c.gex.util.flyToObject(b,{boundsFallback:true,aspectRatio:d})}$(e).trigger("dblclick",[a,b])}}});l=google.earth.addEventListener;
l(j.getGlobe(),"click",function(a){if(a.getButton()!==-1){a=a.getTarget();var b=j.getBalloon();if(a.getType()==="GEGlobe"&&!b)t();else if(a.getType()==="KmlPlacemark"){a=a.getId();a=D(a);a.length>=1?E(a[0],p(a[0])):t()}}});var J=false;l(j.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe")if(b.getType()==="KmlPlacemark"){a=b.getId();var d=D(a);if(d.length>=1)if(!J){J=true;setTimeout(function(){J=false;var f=$(d[0]);$(e).trigger("dblclick",[f,b])},
200)}}}});return e}}();
