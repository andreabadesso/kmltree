(function(){var v={};this.tmpl=function j(l,f){var b=!/\W/.test(l)?(v[l]=v[l]||j(document.getElementById(l).innerHTML)):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+l.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return f?b(f):b}})();
kmldom=function(){return function(v){if(window.ActiveXObject&&window.GetObject){var j=new ActiveXObject("Microsoft.XMLDOM");j.loadXML(v);return jQuery(j)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(v,"text/xml"));throw new Error("No XML parser available");}}();var URI,URIQuery;
(function(){function v(f,b){var d=/^(.*)\//;return f.authority&&!f.path?"/"+b:f.getPath().match(d)[0]+b}function j(f){if(!f)return"";f=f.replace(/\/\.\//g,"/");for(f=f.replace(/\/\.$/,"/");f.match(l);)f=f.replace(l,"/");for(f=f.replace(/\/([^\/]*)\/\.\.$/,"/");f.match(/\/\.\.\//);)f=f.replace(/\/\.\.\//,"/");return f}var l=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(f){f||(f="");f=f.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);var b=f[1]||null,d=f[2]||null,h=
f[3]||null,o=f[4]||null,m=f[5]||null;this.getScheme=function(){return b};this.setScheme=function(r){b=r};this.getAuthority=function(){return d};this.setAuthority=function(r){d=r};this.getPath=function(){return h};this.setPath=function(r){h=r};this.getQuery=function(){return o};this.setQuery=function(r){o=r};this.getFragment=function(){return m};this.setFragment=function(r){m=r}};URI.prototype.toString=function(){var f="";if(this.getScheme())f+=this.getScheme()+":";if(this.getAuthority())f+="//"+this.getAuthority();
if(this.getPath())f+=this.getPath();if(this.getQuery())f+="?"+this.getQuery();if(this.getFragment())f+="#"+this.getFragment();return f};URI.prototype.resolve=function(f){var b=new URI;if(this.getScheme()){b.setScheme(this.getScheme());b.setAuthority(this.getAuthority());b.setPath(j(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getAuthority()){b.setAuthority(this.getAuthority());b.setPath(j(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getPath()){if(this.getPath().charAt(0)===
"/")b.setPath(j(this.getPath()));else{b.setPath(v(f,this.getPath()));b.setPath(j(b.getPath()))}b.setQuery(this.getQuery())}else{b.setPath(f.getPath());this.getQuery()?b.setQuery(this.getQuery()):b.setQuery(f.getQuery())}b.setAuthority(f.getAuthority())}b.setScheme(f.getScheme())}b.setFragment(this.getFragment());return b};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(f,
b){var d=new URIQuery;if(b)d.separator=b;d.addStringParams(f);return d};URIQuery.prototype.addStringParams=function(f){f=f.split(this.separator);for(var b,d,h=0;h<f.length;h++){b=f[h].split("=",2);d=b[0].replace(/\+/g," ");b=b[1].replace(/\+/g," ");this.params.hasOwnProperty(d)||(this.params[d]=[]);this.params[d].push(b)}};URIQuery.prototype.getParam=function(f){if(this.params.hasOwnProperty(f))return this.params[f][0];return null};URIQuery.prototype.toString=function(){var f=[],b;b=this.params;var d=
[];for(var h in b)b.hasOwnProperty(h)&&d.push(h);b=d.sort();for(d=0;d<b.length;d++)for(h=0;h<this.params[b[d]].length;h++)f.push(b[d].replace(/ /g,"+")+"="+this.params[b[d]][h].replace(/ /g,"+"));return f.join(this.separator)}})();
var kmltree=function(){function v(b){var d=document.createElement("a");d.href=b;return d.href}openBalloon=function(b,d){var h=d.createFeatureBalloon("");h.setFeature(b);h.setMinWidth(100);d.setBalloon(h)};var j=function(b){if(b.success&&b.error&&b.tree){this.queue=[];this.opts=b}else throw"missing required option";};j.prototype.add=function(b,d){this.queue.push({node:b,callback:d,loaded:false,errors:false})};j.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var b=
0;b<this.queue.length;b++){var d=this.queue[b];d.node.data("queueItem",d);if(!d.loaded&&!d.loading){var h=this;$(d.node).bind("loaded",function(o,m,r){h.nodeLoadedCallback(o,m,r)});this.opts.tree.openNetworkLink(d.node);d.loading=true}}};j.prototype.nodeLoadedCallback=function(b,d){var h=d.data("queueItem");if(h.loaded===true)throw"event listener fired twice for "+d.find(">span.name").text();h.loaded=true;h.loading=false;$(d).unbind("loaded");h.callback(d);this.execute();this.finish(h)};j.prototype.finish=
function(){for(var b=true,d=true,h=0;h<this.queue.length;h++){b=b&&this.queue[h].loaded;d=d&&!this.queue[h].errors}if(b){d?this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};j.prototype.destroy=function(){for(var b=0;b<this.queue.length;b++)this.queue[b].node.unbind("load");this.queue=[]};var l=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
f={visitFunction:function(b,d){return d},refreshWithState:true,bustCache:false,restoreState:false,supportItemIcon:false,loadingMsg:"Loading data",setExtent:false,displayDocumentRoot:"auto"};return function(b){var d={},h=0,o={};d.lookupTable=o;d.kmlObject=null;b=jQuery.extend({},f,b);var m=b.gex.pluginInstance,r=false,t={};if(parseFloat(m.getPluginVersion())<5.2)throw"kmltree requires a google earth plugin version >= 5.2";if(!b.url||!b.gex||!b.element||!b.mapElement)throw"kmltree requires options url, gex, mapElement & element";
b.element=$(b.element);if(!b.element.attr("id")){b.element.attr("id","kml-tree"+(new Date).getTime());b.element.attr("UNSELECTABLE","on")}b.restoreState&&$(window).unload(function(){d.destroy()});b.element.css("position")!=="absolute"&&$(b.element).css({position:"relative"});var s=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),X=s[0].style.backgroundSize!==
undefined||s[0].style.MozBackgroundSize!==undefined||s[0].style.oBackgroundSize!==undefined||s[0].style.khtmlBackgroundSize!==undefined||s[0].style.webkitBackgroundSize!==undefined,P=function(a,c,e){var g={name:a.getName(),id:"kml"+(e?e.replace(/\W/g,"-"):"")+c.replace(/\W/g,"-")};google.earth.executeBatch(m,function(){b.gex.dom.walk({visitCallback:function(i){var n=i.current;if(!n.children)n.children=[];var p=this.getName(),k;k=n.id;key=p?p.replace(/\W/g,"-"):"blank";k=k+key;for(var q=0;o[k];){q++;
k+=q}o[k]=this;k=k;var A=this.getSnippet();if(!A||A==="empty")A=false;q=this.getType();var O=false;if(q==="KmlPlacemark"){var E=this.getGeometry();if(E)O=E.getType()}var B=this.getComputedStyle();p=p||"&nbsp;";E=!!this.getVisibility();var Y=this.getOpen(),Z=this.getDescription();A=A;var w="check";if(B=B.getListStyle())switch(B.getListItemType()){case 0:break;case 5:w="radioFolder";break;case 2:w="checkOffOnly";break;case 3:w="checkHideChildren";break}B=w;w=false;if(X&&this.getType()==="KmlPlacemark"&&
this.getGeometry()&&this.getGeometry().getType()==="KmlPoint")w=this.getComputedStyle().getIconStyle().getIcon().getHref();if(b.supportItemIcon)w=(w=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?w:false;else w=w;k={renderOptions:F,name:p,visible:E,type:q,open:Y,id:k,description:Z,snippet:A,select:false,listItemType:B,customIcon:w,customClass:"",children:[],alwaysRenderNodes:false,kmlId:this.getId().replace(/\W/g,
"-"),geoType:O};k=b.visitFunction(this,k);n.children.push(k);if(k.listItemType!=="checkHideChildren")i.child=k;else i.walkChildren=false},rootObject:a,rootContext:g})});return g},S=function(a){if(d.kmlObject)throw"KML already loaded";Q();var c=v(b.url);if(a||b.bustCache){a=(new Date).getTime();c=c.indexOf("?")===-1?c+"?cachebuster="+a:c+"&cachebuster="+a}google.earth.fetchKml(m,c,function(e){r||R(e,c,b.url)})};d.load=S;d.refresh=function(){if(b.refreshWithState)d.previousState=K();T();o=null;o={};
m.setBalloon(null);S(true)};var G=function(a){return b.element.find("."+a.replace(/\W/g,"-"))};d.getNodesById=G;d.selectById=function(a){a=G(a)[0];return H(a,u(a))};var y=function(a,c){var e=$("#"+b.element.attr("id")).find(".selected").removeClass("selected");if(e.length){e.each(function(){x($(this),"selected",false)});c||$(d).trigger("select",[null,null])}m.getBalloon()&&!a&&m.setBalloon(null)};d.clearSelection=function(){return y()};var Q=function(a){I();a=a||b.loadingMsg;a=$('<div class="kmltree-loading"><span>'+
a+"</span></div>");var c=b.element.height();c!==0&&a.height(c);b.element.append(a)};d.showLoading=Q;var I=function(){b.element.find(".kmltree-loading").remove()};d.hideLoading=I;var R=function(a,c,e){t={};if(a){h=0;d.kmlObject=a;d.kmlObject.setVisibility(true);var g=P(a,e),i;if(b.displayDocumentRoot===false)i=g.children[0].children;else if(b.displayDocumentRoot===true)i=g.children[0];else{i=g.children[0].children;for(var n=0,p=false;n<i.length&&p===false;){p=i[n].type==="KmlPlacemark";n++}i=p?g.children[0]:
g.children[0].children}i=F(i);b.element.find("div.kmltree").remove();b.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',g.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',i,"</ul></div>"].join(""));m.getFeatures().appendChild(a);if(!d.previousState)if(b.restoreState&&window.localStorage)d.previousState=aa();g=new j({success:function(){I();if(b.setExtent){var k=null,q=$(b.mapElement);if(q.length)k=q.width()/
q.height();b.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:k});b.setExtent=false}$(d).trigger("kmlLoaded",[a])},error:function(){I();$(d).trigger("kmlLoadError",[a])},tree:d});d.previousState?U(d.previousState,g):L(g,$("#"+b.element.attr("id")))}else if(h===0){h++;setTimeout(function(){jQuery.ajax({url:c,success:function(){d.load(true)},error:function(){R(a,c,e)}})},100)}else setTimeout(function(){b.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',
c,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(d).trigger("kmlLoadError",[a])},0)},U=function(a,c){for(var e in a){var g=$("#"+e);if(g.length===1){for(var i in a[e]){g.toggleClass(i,a[e][i].value);x(g,i,a[e][i].value);i==="visible"&&u(g).setVisibility(a[e][i].value)}delete a[e]}}$("#"+b.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var n=$(this);!n.hasClass("checkHideChildren")&&!n.hasClass("loading")&&!n.hasClass("loaded")&&!n.hasClass("error")&&
c.add(n,function(){U(a,c)})});c.execute()},L=function(a,c){c.find("li.KmlNetworkLink.open").each(function(){var e=$(this);if(!e.hasClass("checkHideChildren")&&!e.hasClass("loading")&&!e.hasClass("loaded")){e.removeClass("open");a.add(e,function(g){g.addClass("open");x(g,"open",e.hasClass("open"));L(a,g)})}});a.execute()},F=function(a){if(jQuery.isArray(a)){for(var c=[],e=0;e<a.length;e++)c.push(l(jQuery.extend({},V,a[e])));return c.join("")}else return l(jQuery.extend({},V,a))},V={renderOptions:F},
ba=function(){$(".KmlNetworkLink").each(function(){var a=u($(this));a&&a.getParentNode()&&b.gex.dom.removeObject(u($(this)))})},T=function(){ba();d.kmlObject&&d.kmlObject.getParentNode()&&b.gex.dom.removeObject(d.kmlObject);d.kmlObject=null},aa=function(){var a=localStorage.getItem("kmltree-("+b.url+")");return a?JSON.parse(a):false};d.destroy=function(){r=true;if(b.restoreState&&window.localStorage){var a=JSON.stringify(K());localStorage.setItem("kmltree-("+b.url+")",a)}T();o=null;o={};a=b.element.attr("id");
$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();b.element.html("")};var u=function(a){a=$(a);return a.length?o[a.attr("id")]:false};d.lookup=u;var H=function(a,c){c||(c=u(a));a=$(a);y(true,true);a.addClass("selected");C(a,true);a.addClass("selected");openBalloon(c,m);for(var e=a.parent().parent();!e.hasClass("kmltree")&&!e.find(">ul:visible").length;){e.addClass("open");e=e.parent().parent()}x(a,"selected",true);$(d).trigger("select",[a,c])};d.selectNode=H;var D=
function(a,c){if(c){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){var e=a.find(">ul>li");if(e.length){z($(e[0]),true);D($(e[0]),true)}}}else a.find(">ul>li").each(function(){var g=$(this);if(!g.hasClass("checkOffOnly")){z(g,true);D(g,true)}})}else a.find("li").each(function(){z($(this),false)})},M=function(a,c){var e=a.parent().parent();if(!e.hasClass("kmltree"))if(c){var g=e.parent().parent();g.hasClass("radioFolder")&&g.find(">ul>li.visible").each(function(){if(this!==
e[0]){var i=$(this);z(i,false);D(i,false)}});if(!e.hasClass("visible")){z(e,true);M(e,true)}}else if(e.find(">ul>li.visible").length===0){z(e,false);M(e,false)}},C=function(a,c){if(!(a.hasClass("checkOffOnly")&&c)){var e=a.parent().parent();e.hasClass("radioFolder")&&e.find(">ul>li.visible").each(function(){z($(this),false);D($(this),false)});z(a,c);c&&a.find("li.visible").length||D(a,c);M(a,c)}},z=function(a,c){a=$(a);if(a.hasClass("visible")!==c){x(a,"visible",c);u(a).setVisibility(c);a.toggleClass("visible",
c)}},x=function(a,c,e){a=a.attr("id");t[a]||(t[a]={});a=t[a];if(a[c])a[c].value=e;else a[c]={original:!e,value:e}},K=function(){for(var a in t){for(var c in t[a])t[a][c].original===t[a][c].value&&delete t[a][c];var e=0;for(c in t[a])t[a].hasOwnProperty(c)&&e++;e===0&&delete t[a]}return t};d.getState=K;d.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var c=u(a),e=c.getLink();if(e)var g=e=e.getHref();else{var i=kmldom(c.getKml()).find("Url>href");if(i.length)g=
e=i.text();else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");x(a,"open",false);return}}i=new URI(e);if(i.getAuthority()===null){var n=c.getOwnerDocument();if(n&&n.getUrl)if(n=n.getUrl()){n=new URI(n);var p=i.resolve(n)}if(p)e=p.toString();else alert(["Could not resolve relative link in kml ","document. You may need to upgrade to the ","latest Google Earth Plugin."].join())}if(b.bustCache){p=(new Date).getTime();e=e.indexOf("?")===-1?e+"?cachebuster="+p:e+"&cachebuster="+
p}a.addClass("loading");google.earth.fetchKml(m,e,function(k){if(k){m.getFeatures().appendChild(k);k.setVisibility(c.getVisibility());var q=c.getName();c.getParentNode().getFeatures().removeChild(c);q=P(k,g,q);q=F(q.children[0].children);a.append("<ul>"+q+"</ul>");a.addClass("open");x(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");o[a.attr("id")]=k;$(a).attr("data-rememberedLink",J.length.toString());J.push(c);$(a).trigger("loaded",[a,k]);$(d).trigger("networklinkload",
[a,k])}else{alert("Error loading "+e);a.addClass("error");$(d).trigger("kmlLoadError",[k]);a.removeClass("open")}})}};var J=[];d.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&J.length>=a?J[a]:false};var W=function(a){var c=new j({success:function(){},error:function(){},tree:d});c.add(a,function(e){e.addClass("open");x(e,"open",a.hasClass("open"));L(c,e)});c.execute()};s=b.element.attr("id");$("#"+s+" li > span.name").live("click",function(){var a=$(this).parent(),c=u(a);if(a.hasClass("error")&&
a.hasClass("KmlNetworkLink"))c.getLink()&&c.getLink().getHref()?alert("Could not load NetworkLink with url "+c.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");if(a.hasClass("select"))H(a,c);else{y();if(a.hasClass("hasDescription")||c.getType()==="KmlPlacemark"){c.getType()==="KmlPlacemark"&&C(a,true);openBalloon(c,m,b.whiteListed)}}$(d).trigger("click",[a[0],c])});$("#"+s+" li > span.name").live("contextmenu",function(){var a=$(this).parent(),c=u(a);$(d).trigger("contextmenu",
[a[0],c])});b.element.click(function(a){if(a.target===this)y();else{a=$(a.target);a.hasClass("toggle")&&!a.hasClass("select")&&y()}});$("#"+s+" li > .expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))W(a);else{a.toggleClass("open");x(a,"open",a.hasClass("open"))}});$("#"+s+" li > .toggler").live("click",function(){var a=$(this).parent(),c=!a.hasClass("visible");!c&&a.hasClass("selected")&&y();!c&&m.getBalloon()&&
m.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&c)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){W(a);$(a).bind("loaded",function(e,g){C(g,true);g.removeClass("open")})}else C(a,c);$(d).trigger("toggleItem",[a,c,u(a)])}});$("#"+s+" li").live("dblclick",function(a){var c=$(a.target);a=c.parent();if(!(c.hasClass("expander")||c.hasClass("toggler")||a.hasClass("expander")||a.hasClass("toggler"))){c=$(this);var e=
u(c);if(c.hasClass("error"))e.getLink()&&e.getLink().getHref()?alert("Could not load NetworkLink with url "+e.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{C(c,true);if(e.getType()=="KmlTour")m.getTourPlayer().setTour(e);else{var g=null,i=$(b.mapElement);if(i.length)g=i.width()/i.height();b.gex.util.flyToObject(e,{boundsFallback:a.find("li").length<1E3,aspectRatio:g})}$(d).trigger("dblclick",[c,e])}}});s=google.earth.addEventListener;s(m.getGlobe(),"click",
function(a){if(a.getButton()!==-1){a=a.getTarget();var c=m.getBalloon();if(a.getType()==="GEGlobe"&&!c)y();else if(a.getType()==="KmlPlacemark"){a=a.getId();a=G(a);a.length>=1?H(a[0],u(a[0])):y()}}});var N=false;s(m.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var c=a.getTarget();if(c.getType()!=="GEGlobe")if(c.getType()==="KmlPlacemark"){a=c.getId();var e=G(a);if(e.length>=1)if(!N){N=true;setTimeout(function(){N=false;var g=$(e[0]);$(d).trigger("dblclick",[g,c])},200)}}}});d.removeEventListener=
d.detachEvent=function(){};return d}}(),enableGoogleLayersControl=function(){var v=function(j,l,f){if((j=j.getId())&&j.match(/^LAYER/))f.getLayerRoot().enableLayerById(f[j],l);else{var b=f.getOptions();switch(j){case "SUN":f.getSun().setVisibility(l);break;case "NAVIGATION_CONTROLS":j=f.VISIBILITY_SHOW;if(!l)j=f.VISIBILITY_HIDE;f.getNavigationControl().setVisibility(j);break;case "STATUS_BAR":b.setStatusBarVisibility(l);break;case "OVERVIEW_MAP":b.setOverviewMapVisibility(l);break;case "SCALE_LEGEND":b.setScaleLegendVisibility(l);
break;case "ATMOSPHERE":b.setAtmosphereVisibility(l);break;case "HISTORICAL_IMAGERY":f.getTime().setHistoricalImageryEnabled(l);break;case "GRID":b.setGridVisibility(l);break}}};return function(j,l){if(!j||!l)alert("Must call enableGoogleLayersControl with both tree and ge options!");$(j).bind("toggleItem",function(f,b,d,h){v(h,d,l)});$(j).bind("kmlLoaded",function(f,b){for(var d=b.getFeatures().getChildNodes(),h=d.getLength(),o=0;o<h;o++){var m=d.item(o);v(m,m.getVisibility(),l)}})}}();
