(function(){var u={};this.tmpl=function m(o,x){o=!/\W/.test(o)?(u[o]=u[o]||m(document.getElementById(o).innerHTML)):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+o.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return x?o(x):o}})();
kmldom=function(){return function(u){if(window.ActiveXObject&&window.GetObject){var m=new ActiveXObject("Microsoft.XMLDOM");m.loadXML(u);return jQuery(m)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(u,"text/xml"));throw new Error("No XML parser available");}}();
var kmltree=function(){function u(d){var e=document.createElement("a");e.href=d;return e.href}openBalloon=function(d,e){var j=e.createFeatureBalloon("");j.setFeature(d);j.setMinWidth(100);e.setBalloon(j)};var m=function(d){if(d.success&&d.error&&d.tree){this.queue=[];this.opts=d}else throw"missing required option";};m.prototype.add=function(d,e){this.queue.push({node:d,callback:e,loaded:false,errors:false})};m.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var d=
0;d<this.queue.length;d++){var e=this.queue[d];e.node.data("queueItem",e);if(!e.loaded&&!e.loading){var j=this;$(e.node).bind("loaded",function(p,h,y){j.nodeLoadedCallback(p,h,y)});this.opts.tree.openNetworkLink(e.node);e.loading=true}}};m.prototype.nodeLoadedCallback=function(d,e){d=e.data("queueItem");if(d.loaded===true)throw"event listener fired twice for "+e.find(">span.name").text();d.loaded=true;d.loading=false;$(e).unbind("loaded");d.callback(e);this.execute();this.finish(d)};m.prototype.finish=
function(){for(var d=true,e=true,j=0;j<this.queue.length;j++){d=d&&this.queue[j].loaded;e=e&&!this.queue[j].errors}if(d){e?this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};m.prototype.destroy=function(){for(var d=0;d<this.queue.length;d++)this.queue[d].node.unbind("load");this.queue=[]};var o=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon">&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
x={enableSelection:function(){return false},visitFunction:function(d,e){return e},openNetworkLinks:true,refreshWithState:true,bustCache:false,restoreState:false,supportItemIcon:false,loadingMsg:"Loading data",setExtent:false};return function(d){var e={},j=0,p={};e.lookupTable=p;e.kmlObject=null;d=jQuery.extend({},x,d);var h=d.gex.pluginInstance,y=false,l={};if(parseFloat(h.getPluginVersion())<5.2)throw"kmltree requires a google earth plugin version >= 5.2";if(!d.url||!d.gex||!d.element)throw"kmltree requires options url, gex & element";
if(!d.element.attr("id")){d.element.attr("id","kml-tree"+(new Date).getTime());d.element.attr("UNSELECTABLE","on")}d.restoreState&&$(window).unload(function(){e.destroy()});d.element.css("position")!=="absolute"&&$(d.element).css({position:"relative"});var k=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),R=k[0].style.backgroundSize!==undefined||
k[0].style.MozBackgroundSize!==undefined||k[0].style.oBackgroundSize!==undefined||k[0].style.khtmlBackgroundSize!==undefined||k[0].style.webkitBackgroundSize!==undefined,I=function(a,b){var c={name:a.getName(),id:"kml"+b.replace(/\W/g,"-")};google.earth.executeBatch(h,function(){d.gex.dom.walk({visitCallback:function(f){var i=f.current;if(!i.children)i.children=[];var g=this.getName(),q=S(this,i.id,b,g),z=this.getSnippet();if(!z||z==="empty")z=false;var T=this.getComputedStyle();g={renderOptions:A,
name:g||"&nbsp;",visible:!!this.getVisibility(),type:this.getType(),open:this.getOpen(),id:q,description:this.getDescription(),snippet:z,select:d.enableSelection(this),listItemType:U(T),customIcon:V(this),customClass:"",children:[],alwaysRenderNodes:false,kmlId:this.getId().replace(/\W/g,"-")};g=d.visitFunction(this,g);i.children.push(g);if(g.listItemType!=="checkHideChildren")f.child=g;else f.walkChildren=false},rootObject:a,rootContext:c})});return c},L=function(a){if(e.kmlObject)throw"KML already loaded";
J();var b=u(d.url);if(a||d.bustCache){a=(new Date).getTime();b=b.indexOf("?")===-1?b+"?cachebuster="+a:b+"&cachebuster="+a}google.earth.fetchKml(h,b,function(c){y||K(c,b,d.url)})};e.load=L;var B=function(a){return d.element.find("."+a.replace(/\W/g,"-"))};e.getNodesById=B;e.selectById=function(a){a=B(a)[0];return C(a,n(a))};var s=function(a,b){var c=$("#"+d.element.attr("id")).find(".selected").removeClass("selected");if(c.length){c.each(function(){r($(this),"selected",false)});b||$(e).trigger("select",
[null,null])}h.getBalloon()&&!a&&h.setBalloon(null)};e.clearSelection=s;var J=function(a){D();a=a||d.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var b=d.element.height();b!==0&&a.height(b);d.element.append(a)};e.showLoading=J;var D=function(){d.element.find(".kmltree-loading").remove()};e.hideLoading=D;var K=function(a,b,c){l={};if(a){j=0;e.kmlObject=a;e.kmlObject.setVisibility(true);var f=I(a,c),i=A(f.children[0].children);d.element.find("div.kmltree").remove();d.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',
f.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',i,"</ul></div>"].join(""));h.getFeatures().appendChild(a);if(!e.previousState)if(d.restoreState&&window.localStorage)e.previousState=W();f=new m({success:function(){D();if(d.setExtent){var g=null,q=$(d.map_div);if(q.length)g=q.width()/q.height();d.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:g});d.setExtent=false}$(e).trigger("kmlLoaded",[a])},error:function(){D();$(e).trigger("kmlLoadError",[a])},tree:e});e.previousState?
M(e.previousState,f):E(f,$("#"+d.element.attr("id")))}else if(j===0){j++;setTimeout(function(){jQuery.ajax({url:b,success:function(){e.load(true)},error:function(){K(a,b,c)}})},100)}else setTimeout(function(){d.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',b,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(e).trigger("kmlLoadError",[a])},0)},M=function(a,b){for(var c in a){var f=
$("#"+c);if(f.length===1){for(var i in a[c]){f.toggleClass(i,a[c][i].value);r(f,i,a[c][i].value);i==="visible"&&n(f).setVisibility(a[c][i].value)}delete a[c]}}$("#"+d.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var g=$(this);!g.hasClass("checkHideChildren")&&!g.hasClass("loading")&&!g.hasClass("loaded")&&!g.hasClass("error")&&b.add(g,function(){M(a,b)})});b.execute()},E=function(a,b){b.find("li.KmlNetworkLink.open").each(function(){var c=$(this);if(!c.hasClass("checkHideChildren")&&
!c.hasClass("loading")&&!c.hasClass("loaded")){c.removeClass("open");a.add(c,function(f){f.addClass("open");r(f,"open",c.hasClass("open"));E(a,f)})}});a.execute()},V=function(a){var b=false;if(R&&a.getType()=="KmlPlacemark")b=a.getComputedStyle().getIconStyle().getIcon().getHref();if(!d.supportItemIcon)return b;return(a=kmldom(a.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?a:false},U=function(a){var b="check";if(a=a.getListStyle())switch(a.getListItemType()){case 0:break;
case 5:b="radioFolder";break;case 2:b="checkOffOnly";break;case 3:b="checkHideChildren";break}return b},A=function(a){if(jQuery.isArray(a)){for(var b=[],c=0;c<a.length;c++)b.push(N(a[c]));return b.join("")}else return N(a)},X={renderOptions:A},N=function(a){return o(jQuery.extend({},X,a))},O=function(){p=null;p={}};e.refresh=function(){if(d.refreshWithState)e.previousState=F();P();O();h.setBalloon(null);L(true)};var Y=function(){$(".KmlNetworkLink").each(function(){n($(this)).getParentNode()&&d.gex.dom.removeObject(n($(this)))})},
P=function(){Y();e.kmlObject&&e.kmlObject.getParentNode()&&d.gex.dom.removeObject(e.kmlObject);e.kmlObject=null},W=function(){var a=localStorage.getItem("kmltree-("+d.url+")");return a?JSON.parse(a):false},Z=function(){var a=JSON.stringify(F());localStorage.setItem("kmltree-("+d.url+")",a)};e.destroy=function(){y=true;d.restoreState&&window.localStorage&&Z();P();O();var a=d.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();d.element.html("")};
var n=function(a){a=$(a);return a.length?p[a.attr("id")]:false};e.lookup=n;var S=function(a,b,c,f){b=aa(a,b,c,f);if(p[b])throw"attempting to add lookup that already exists!";p[b]=a;return b},aa=function(a,b,c,f){key=f?f.replace(/\W/g,"-"):"blank";return b+key},ba=function(a,b){p[a.attr("id")]=b},C=function(a,b){b||(b=n(a));a=$(a);s(true,true);a.addClass("selected");v(a,true);a.addClass("selected");openBalloon(b,h);for(var c=a.parent().parent();!c.hasClass("kmltree")&&!c.find(">ul:visible").length;){c.addClass("open");
c=c.parent().parent()}r(a,"selected",true);$(e).trigger("select",[a,b])};e.selectNode=C;var w=function(a,b){if(b){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){a=a.find(">ul>li");if(a.length){t($(a[0]),true);w($(a[0]),true)}}}else a.find(">ul>li").each(function(){var c=$(this);if(!c.hasClass("checkOffOnly")){t(c,true);w(c,true)}})}else a.find("li").each(function(){t($(this),false)})},G=function(a,b){var c=a.parent().parent();if(!c.hasClass("kmltree"))if(b){a=
c.parent().parent();a.hasClass("radioFolder")&&a.find(">ul>li.visible").each(function(){if(this!==c[0]){var f=$(this);t(f,false);w(f,false)}});if(!c.hasClass("visible")){t(c,true);G(c,true)}}else if(c.find(">ul>li.visible").length===0){t(c,false);G(c,false)}},v=function(a,b){if(!(a.hasClass("checkOffOnly")&&b)){var c=a.parent().parent();c.hasClass("radioFolder")&&c.find(">ul>li.visible").each(function(){t($(this),false);w($(this),false)});t(a,b);w(a,b);G(a,b)}},t=function(a,b){a=$(a);if(a.hasClass("visible")!==
b){r(a,"visible",b);n(a).setVisibility(b);a.toggleClass("visible",b)}},r=function(a,b,c){a=a.attr("id");l[a]||(l[a]={});a=l[a];if(a[b])a[b].value=c;else a[b]={original:!c,value:c}},F=function(){for(var a in l){for(var b in l[a])l[a][b].original===l[a][b].value&&delete l[a][b];var c=0;for(b in l[a])l[a].hasOwnProperty(b)&&c++;c===0&&delete l[a]}return l};e.getState=F;e.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var b=n(a),c=b.getLink();if(c){var f=c=
c.getHref();if(d.bustCache){var i=(new Date).getTime();c=c.indexOf("?")===-1?c+"?cachebuster="+i:c+"&cachebuster="+i}a.addClass("loading");google.earth.fetchKml(h,c,function(g){if(g){h.getFeatures().appendChild(g);g.setVisibility(b.getVisibility());b.getParentNode().getFeatures().removeChild(b);var q=I(g,f);q=A(q.children[0].children);a.append("<ul>"+q+"</ul>");a.addClass("open");r(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");ba(a,g);$(a).trigger("loaded",[a,g]);$(e).trigger("networklinkload",
[a,g])}else{alert("Error loading "+c);a.addClass("error");$(e).trigger("kmlLoadError",[g]);a.removeClass("open")}})}else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");r(a,"open",false)}}};var Q=function(a){var b=new m({success:function(){},error:function(){},tree:e});b.add(a,function(c){c.addClass("open");r(c,"open",a.hasClass("open"));E(b,c)});b.execute()};k=d.element.attr("id");$("#"+k+" li > span.name").live("click",function(){var a=$(this).parent(),b=n(a);if(a.hasClass("error")&&
a.hasClass("KmlNetworkLink"))b.getLink()&&b.getLink().getHref()?alert("Could not load NetworkLink with url "+b.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");if(a.hasClass("select"))C(a,b);else{s();if(a.hasClass("hasDescription")||b.getType()==="KmlPlacemark"){b.getType()==="KmlPlacemark"&&v(a,true);openBalloon(b,h,d.whiteListed)}}$(e).trigger("click",[a[0],b])});$("#"+k+" li > span.name").live("contextmenu",function(){var a=$(this).parent(),b=n(a);$(e).trigger("contextmenu",
[a[0],b])});d.element.click(function(a){if(a.target===this)s();else{a=$(a.target);a.hasClass("toggle")&&!a.hasClass("select")&&s()}});$("#"+k+" li > .expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))Q(a);else{a.toggleClass("open");r(a,"open",a.hasClass("open"))}});$("#"+k+" li > .toggler").live("click",function(){var a=$(this).parent(),b=!a.hasClass("visible");!b&&a.hasClass("selected")&&s();!b&&h.getBalloon()&&
h.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&b)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){Q(a);$(a).bind("loaded",function(c,f){v(f,true);f.removeClass("open")})}else v(a,b);$(e).trigger("toggleItem",[a,b])}});$("#"+k+" li").live("dblclick",function(a){a=$(a.target);var b=a.parent();if(!(a.hasClass("expander")||a.hasClass("toggler")||b.hasClass("expander")||b.hasClass("toggler"))){a=$(this);b=n(a);
if(a.hasClass("error"))b.getLink()&&b.getLink().getHref()?alert("Could not load NetworkLink with url "+b.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{v(a,true);if(b.getType()=="KmlTour")h.getTourPlayer().setTour(b);else{var c=null,f=$(d.map_div);if(f.length)c=f.width()/f.height();d.gex.util.flyToObject(b,{boundsFallback:true,aspectRatio:c})}$(e).trigger("dblclick",[a,b])}}});k=google.earth.addEventListener;k(h.getGlobe(),"click",function(a){if(a.getButton()!==
-1){a=a.getTarget();var b=h.getBalloon();if(a.getType()==="GEGlobe"&&!b)s();else if(a.getType()==="KmlPlacemark"){a=a.getId();a=B(a);a.length>=1?C(a[0],n(a[0])):s()}}});var H=false;k(h.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe")if(b.getType()==="KmlPlacemark"){a=b.getId();var c=B(a);if(c.length>=1)if(!H){H=true;setTimeout(function(){H=false;var f=$(c[0]);$(e).trigger("dblclick",[f,b])},200)}}}});return e}}();
