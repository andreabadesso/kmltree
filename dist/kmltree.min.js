var kmltreeManager=function(){that={};var i=[],h,j={};that.register=function(g,k){if(i.length===0){h=k.opts.gex.pluginInstance;google.earth.addEventListener(h,"balloonopening",b);google.earth.addEventListener(h,"balloonclose",c)}i.push({key:"kmltree-tree-"+i.length.toString(),instance:g,api:k})};that.remove=function(g){for(var k=0;k<i.length;k++)if(i[k].instance===g){i.splice(k,1);break}return g};that.pauseListeners=function(g){google.earth.removeEventListener(h,"balloonopening",b);google.earth.removeEventListener(h,
"balloonclose",c);g();google.earth.addEventListener(h,"balloonopening",b);google.earth.addEventListener(h,"balloonclose",c)};var d=function(g){for(var k=0;k<i.length;k++)if(i[k].instance===g)return i[k].api},b=function(g){var k=g.getFeature(),m=p(k);if(m){g.preventDefault();h.setBalloon(null);t(k,m);return false}},c=function(){$("#kmltree-balloon-iframe").remove();for(var g=0;g<i.length;g++)i[g].instance.clearSelection()},l=function(g,k){if(g.getUrl()===k)return true;if(g.getElementByUrl(k))return true},
p=function(g){g=g.getUrl();var k=g.split("#")[0];if(j[k])return j[k];for(var m=0;m<i.length;m++)if(l(i[m].instance.kmlObject,g)){j[k]=i[m];return i[m]}for(m=0;m<i.length;m++)for(var q=i[m].api.docs,w=0;w<q.length;w++)if(l(q[w],g)){j[k]=i[m];return i[m]}return false},t=function(g,k){var m;k=k.instance?k.instance:k;var q=k.api?k.api:d(k);m=q.opts.displayEnhancedContent;if(typeof m==="function")m=m(g);if(m){var w=g.getBalloonHtmlUnsafe(),x=g.getBalloonHtml();x=$.trim(x.replace(/\s*<\!--\s*Content-type: mhtml-die-die-die\s*--\>/,
""));x=x!=$.trim(w)}if(m&&x){m=h.createHtmlDivBalloon("");x=$(['<iframe id="kmltree-balloon-iframe" border="0" frameBorder="0" src="',q.opts.iframeSandbox,'"></iframe>'].join(""));var B=document.createElement("div");$(B).append(x);x.load(function(){this.contentWindow.postMessage(JSON.stringify({html:Base64.encode(w),callback:Base64.encode(q.opts.sandboxedBalloonCallback.toString())}),"*")});m.setContentDiv(B)}else{m=h.createFeatureBalloon("");var z=function(C){setTimeout(function(){$(k).trigger("balloonopen",
[C.getBalloon(),C.getFeature()])},1);google.earth.removeEventListener(h,"balloonopening",z)};google.earth.addEventListener(h,"balloonopening",z)}m.setFeature(g);h.setBalloon(m)};that.openBalloon=t;$(window).bind("message",function(g){g=g.originalEvent;var k=g;g=h.getBalloon();var m=g.getFeature(),q;if(!(q=!$("#kmltree-balloon-iframe").length))if(!(q=!(k.data.match(/width/)||k.data.match(/unknownIframeDimensions/))))if(!(q=g.getType()!=="GEHtmlDivBalloon")){q=$(g.getContentDiv()).find("iframe")[0];
var w;b:for(var x=k.source,B=document.getElementsByTagName("iframe"),z=0;z<B.length;z++)if(B[0].contentWindow===x){w=B[z];break b}q=q!==w}if(!q){w=p(m);k=JSON.parse(k.data);if(k.unknownIframeDimensions){k=w.api.opts.unknownIframeDimensionsDefault;if(typeof k==="function")k=k(m)}q=$("#kmltree-balloon-iframe");g.setMinWidth(k.width);g.setMaxWidth(k.width+k.width*0.1);g.setMinHeight(k.height);g.setMaxHeight(k.height+k.height*0.1);q.height(k.height);q.width(k.width);$(w.instance).trigger("balloonopen",
[g,m])}});return that}(),Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(i){var h="",j,d,b,c,l,p,t=0;for(i=Base64._utf8_encode(i);t<i.length;){j=i.charCodeAt(t++);d=i.charCodeAt(t++);b=i.charCodeAt(t++);c=j>>2;j=(j&3)<<4|d>>4;l=(d&15)<<2|b>>6;p=b&63;if(isNaN(d))l=p=64;else if(isNaN(b))p=64;h=h+this._keyStr.charAt(c)+this._keyStr.charAt(j)+this._keyStr.charAt(l)+this._keyStr.charAt(p)}return h},decode:function(i){var h="",j,d,b,c,l,p=0;for(i=i.replace(/[^A-Za-z0-9\+\/\=]/g,
"");p<i.length;){j=this._keyStr.indexOf(i.charAt(p++));d=this._keyStr.indexOf(i.charAt(p++));c=this._keyStr.indexOf(i.charAt(p++));l=this._keyStr.indexOf(i.charAt(p++));j=j<<2|d>>4;d=(d&15)<<4|c>>2;b=(c&3)<<6|l;h+=String.fromCharCode(j);if(c!=64)h+=String.fromCharCode(d);if(l!=64)h+=String.fromCharCode(b)}return h=Base64._utf8_decode(h)},_utf8_encode:function(i){i=i.replace(/\r\n/g,"\n");for(var h="",j=0;j<i.length;j++){var d=i.charCodeAt(j);if(d<128)h+=String.fromCharCode(d);else{if(d>127&&d<2048)h+=
String.fromCharCode(d>>6|192);else{h+=String.fromCharCode(d>>12|224);h+=String.fromCharCode(d>>6&63|128)}h+=String.fromCharCode(d&63|128)}}return h},_utf8_decode:function(i){for(var h="",j=0,d=c1=c2=0;j<i.length;){d=i.charCodeAt(j);if(d<128){h+=String.fromCharCode(d);j++}else if(d>191&&d<224){c2=i.charCodeAt(j+1);h+=String.fromCharCode((d&31)<<6|c2&63);j+=2}else{c2=i.charCodeAt(j+1);c3=i.charCodeAt(j+2);h+=String.fromCharCode((d&15)<<12|(c2&63)<<6|c3&63);j+=3}}return h}};
(function(){var i={};this.tmpl=function h(j,d){var b=!/\W/.test(j)?i[j]=i[j]||h(document.getElementById(j).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+j.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return d?b(d):b}})();
kmldom=function(){return function(i){if(window.ActiveXObject&&window.GetObject){var h=new ActiveXObject("Microsoft.XMLDOM");h.loadXML(i);return jQuery(h)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(i,"text/xml"));throw Error("No XML parser available");}}();var URI,URIQuery;
(function(){function i(d,b){var c=/^(.*)\//;return d.authority&&!d.path?"/"+b:d.getPath().match(c)[0]+b}function h(d){if(!d)return"";d=d.replace(/\/\.\//g,"/");for(d=d.replace(/\/\.$/,"/");d.match(j);)d=d.replace(j,"/");for(d=d.replace(/\/([^\/]*)\/\.\.$/,"/");d.match(/\/\.\.\//);)d=d.replace(/\/\.\.\//,"/");return d}var j=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(d){d||(d="");d=d.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);var b=d[1]||null,c=d[2]||null,l=
d[3]||null,p=d[4]||null,t=d[5]||null;this.getScheme=function(){return b};this.setScheme=function(g){b=g};this.getAuthority=function(){return c};this.setAuthority=function(g){c=g};this.getPath=function(){return l};this.setPath=function(g){l=g};this.getQuery=function(){return p};this.setQuery=function(g){p=g};this.getFragment=function(){return t};this.setFragment=function(g){t=g}};URI.prototype.toString=function(){var d="";if(this.getScheme())d+=this.getScheme()+":";if(this.getAuthority())d+="//"+this.getAuthority();
if(this.getPath())d+=this.getPath();if(this.getQuery())d+="?"+this.getQuery();if(this.getFragment())d+="#"+this.getFragment();return d};URI.prototype.resolve=function(d){var b=new URI;if(this.getScheme()){b.setScheme(this.getScheme());b.setAuthority(this.getAuthority());b.setPath(h(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getAuthority()){b.setAuthority(this.getAuthority());b.setPath(h(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getPath()){if(this.getPath().charAt(0)===
"/")b.setPath(h(this.getPath()));else{b.setPath(i(d,this.getPath()));b.setPath(h(b.getPath()))}b.setQuery(this.getQuery())}else{b.setPath(d.getPath());this.getQuery()?b.setQuery(this.getQuery()):b.setQuery(d.getQuery())}b.setAuthority(d.getAuthority())}b.setScheme(d.getScheme())}b.setFragment(this.getFragment());return b};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(d,
b){var c=new URIQuery;if(b)c.separator=b;c.addStringParams(d);return c};URIQuery.prototype.addStringParams=function(d){d=d.split(this.separator);for(var b,c,l=0;l<d.length;l++){b=d[l].split("=",2);c=b[0].replace(/\+/g," ");b=b[1].replace(/\+/g," ");this.params.hasOwnProperty(c)||(this.params[c]=[]);this.params[c].push(b)}};URIQuery.prototype.getParam=function(d){if(this.params.hasOwnProperty(d))return this.params[d][0];return null};URIQuery.prototype.toString=function(){var d=[],b;b=this.params;var c=
[],l;for(l in b)b.hasOwnProperty(l)&&c.push(l);b=c.sort();for(c=0;c<b.length;c++)for(l=0;l<this.params[b[c]].length;l++)d.push(b[c].replace(/ /g,"+")+"="+this.params[b[c]][l].replace(/ /g,"+"));return d.join(this.separator)}})();
var kmltree=function(){function i(b){var c=document.createElement("a");c.href=b;return c.href}var h=function(b){if(b.success&&b.error&&b.tree){this.queue=[];this.opts=b}else throw"missing required option";};h.prototype.add=function(b,c){this.queue.push({node:b,callback:c,loaded:false,errors:false})};h.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var b=0;b<this.queue.length;b++){var c=this.queue[b];c.node.data("queueItem",c);if(!c.loaded&&!c.loading){var l=this;
$(c.node).bind("loaded",function(p,t,g){l.nodeLoadedCallback(p,t,g)});this.opts.tree.openNetworkLink(c.node);c.loading=true}}};h.prototype.nodeLoadedCallback=function(b,c){var l=c.data("queueItem");if(l.loaded===true)throw"event listener fired twice for "+c.find(">span.name").text();l.loaded=true;l.loading=false;$(c).unbind("loaded");l.callback(c);this.execute();this.finish(l)};h.prototype.finish=function(){for(var b=true,c=true,l=0;l<this.queue.length;l++){b=b&&this.queue[l].loaded;c=c&&!this.queue[l].errors}if(b){c?
this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};h.prototype.destroy=function(){for(var b=0;b<this.queue.length;b++)this.queue[b].node.unbind("load");this.queue=[]};var j=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
d={visitFunction:function(b,c){return c},refreshWithState:true,bustCache:false,restoreState:false,whitelist:[],supportItemIcon:false,loadingMsg:"Loading data",setExtent:false,displayDocumentRoot:"auto",displayEnhancedContent:false,iframeSandbox:"http://underbluewaters-try-unsafe-popups.googlecode.com/hg/src/iframe.html",unknownIframeDimensionsDefault:{height:450,width:530},sandboxedBalloonCallback:function(){}};return function(b){var c={},l=0,p={};c.lookupTable=p;c.kmlObject=null;var t=[];b=jQuery.extend({},
d,b);var g=b.gex.pluginInstance,k=false,m={};parseFloat(g.getPluginVersion())<5.2&&alert("kmltree requires a google earth plugin version >= 5.2");if(!b.url||!b.gex||!b.element||!b.mapElement)throw"kmltree requires options url, gex, mapElement & element";b.element=$(b.element);if(!b.element.attr("id")){b.element.attr("id","kml-tree"+(new Date).getTime());b.element.attr("UNSELECTABLE","on")}b.restoreState&&$(window).unload(function(){c.destroy()});b.element.css("position")!=="absolute"&&$(b.element).css({position:"relative"});
var q=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),w=q[0].style.backgroundSize!==undefined||q[0].style.MozBackgroundSize!==undefined||q[0].style.oBackgroundSize!==undefined||q[0].style.khtmlBackgroundSize!==undefined||q[0].style.webkitBackgroundSize!==undefined,x=function(a,e,f){var n={name:a.getName(),id:"kml"+(f?f.replace(/\W/g,"-"):"")+e.replace(/\W/g,
"-")};google.earth.executeBatch(g,function(){b.gex.dom.walk({visitCallback:function(o){var s=o.current;if(!s.children)s.children=[];var u=this.getName(),r;r=s.id;key=u?u.replace(/\W/g,"-"):"blank";r+=key;for(var v=0;p[r];){v++;r+=v}p[r]=this;var I=this.getSnippet();if(!I||I==="empty")I=false;v=this.getType();var S=false;if(v==="KmlPlacemark"){var J=this.getGeometry();if(J)S=J.getType()}var F=this.getComputedStyle();u=u||"&nbsp;";J=!!this.getVisibility();var Z=this.getOpen(),aa=this.getDescription(),
A="check";if(F=F.getListStyle())switch(F.getListItemType()){case 5:A="radioFolder";break;case 2:A="checkOffOnly";break;case 3:A="checkHideChildren"}F=A;A=false;if(w&&this.getType()==="KmlPlacemark"&&this.getGeometry()&&this.getGeometry().getType()==="KmlPoint")A=this.getComputedStyle().getIconStyle().getIcon().getHref();if(b.supportItemIcon)A=(A=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?A:false;r={renderOptions:K,
name:u,visible:J,type:v,open:Z,id:r,description:aa,snippet:I,select:false,listItemType:F,customIcon:A,customClass:"",children:[],alwaysRenderNodes:false,kmlId:this.getId().replace(/\W/g,"-"),geoType:S};r=b.visitFunction(this,r);s.children.push(r);if(r.listItemType!=="checkHideChildren")o.child=r;else o.walkChildren=false},rootObject:a,rootContext:n})});return n},B=function(a){if(c.kmlObject)throw"KML already loaded";T();var e=i(b.url);if(a||b.bustCache){a=(new Date).getTime();e=e.indexOf("?")===-1?
e+"?cachebuster="+a:e+"&cachebuster="+a}google.earth.fetchKml(g,e,function(f){k||U(f,e,b.url)})};c.load=B;c.refresh=function(){if(b.refreshWithState)c.previousState=N();V();p=null;p={};g.setBalloon(null);B(true)};var z=function(a){return b.element.find("."+a.replace(/\W/g,"-"))};c.getNodesById=z;c.selectById=function(a){a=z(a)[0];return O(a,y(a))};var C=function(a,e){var f=$("#"+b.element.attr("id")).find(".selected").removeClass("selected");if(f.length){f.each(function(){D($(this),"selected",false)});
e||$(c).trigger("select",[null,null])}g.getBalloon()&&!a&&g.setBalloon(null)};c.clearSelection=function(){return C()};var T=function(a){L();a=a||b.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var e=b.element.height();e!==0&&a.height(e);b.element.append(a)};c.showLoading=T;var L=function(){b.element.find(".kmltree-loading").remove()};c.hideLoading=L;var U=function(a,e,f){m={};if(a){l=0;c.kmlObject=a;t.push(a);c.kmlObject.setVisibility(true);var n=x(a,f),o;if(b.displayDocumentRoot===
false)o=n.children[0].children;else if(b.displayDocumentRoot===true)o=n.children[0];else{o=n.children[0].children;for(var s=0,u=false;s<o.length&&u===false;){u=o[s].type==="KmlPlacemark";s++}o=u?n.children[0]:n.children[0].children}o=K(o);b.element.find("div.kmltree").remove();b.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',n.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',o,"</ul></div>"].join(""));g.getFeatures().appendChild(a);
if(!c.previousState)if(b.restoreState&&window.localStorage)c.previousState=ba();n=new h({success:function(){L();if(b.setExtent){var r=null,v=$(b.mapElement);if(v.length)r=v.width()/v.height();b.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:r});b.setExtent=false}$(c).trigger("kmlLoaded",[a])},error:function(){L();$(c).trigger("kmlLoadError",[a])},tree:c});c.previousState?W(c.previousState,n):P(n,$("#"+b.element.attr("id")))}else if(l===0){l++;setTimeout(function(){jQuery.ajax({url:e,success:function(){c.load(true)},
error:function(){U(a,e,f)}})},100)}else setTimeout(function(){b.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',e,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(c).trigger("kmlLoadError",[a])},0)},W=function(a,e){for(var f in a){var n=$("#"+f);if(n.length===1){for(var o in a[f]){n.toggleClass(o,a[f][o].value);D(n,o,a[f][o].value);o==="visible"&&y(n).setVisibility(a[f][o].value)}delete a[f]}}$("#"+
b.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var s=$(this);!s.hasClass("checkHideChildren")&&!s.hasClass("loading")&&!s.hasClass("loaded")&&!s.hasClass("error")&&e.add(s,function(){W(a,e)})});e.execute()},P=function(a,e){e.find("li.KmlNetworkLink.open").each(function(){var f=$(this);if(!f.hasClass("checkHideChildren")&&!f.hasClass("loading")&&!f.hasClass("loaded")){f.removeClass("open");a.add(f,function(n){n.addClass("open");D(n,"open",f.hasClass("open"));P(a,n)})}});a.execute()},
K=function(a){if(jQuery.isArray(a)){for(var e=[],f=0;f<a.length;f++)e.push(j(jQuery.extend({},X,a[f])));return e.join("")}else return j(jQuery.extend({},X,a))},X={renderOptions:K},ca=function(){$(".KmlNetworkLink").each(function(){var a=y($(this));a&&a.getParentNode()&&b.gex.dom.removeObject(y($(this)))})},V=function(){ca();c.kmlObject&&c.kmlObject.getParentNode()&&b.gex.dom.removeObject(c.kmlObject);c.kmlObject=null;t=[]},ba=function(){var a=localStorage.getItem("kmltree-("+b.url+")");return a?JSON.parse(a):
false};c.destroy=function(){k=true;kmltreeManager.remove(c);if(b.restoreState&&window.localStorage){var a=JSON.stringify(N());localStorage.setItem("kmltree-("+b.url+")",a)}V();p=null;p={};a=b.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();b.element.html("")};var y=function(a){a=$(a);return a.length?p[a.attr("id")]:false};c.lookup=y;var O=function(a,e){e||(e=y(a));a=$(a);C(true,true);a.addClass("selected");G(a,true);a.addClass("selected");
kmltreeManager.pauseListeners(function(){kmltreeManager.openBalloon(e,c)});for(var f=a.parent().parent();!f.hasClass("kmltree")&&!f.find(">ul:visible").length;){f.addClass("open");f=f.parent().parent()}D(a,"selected",true);$(c).trigger("select",[a,e])};c.selectNode=O;var H=function(a,e){if(e){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){var f=a.find(">ul>li");if(f.length){E($(f[0]),true);H($(f[0]),true)}}}else a.find(">ul>li").each(function(){var n=
$(this);if(!n.hasClass("checkOffOnly")){E(n,true);H(n,true)}})}else a.find("li").each(function(){E($(this),false)})},Q=function(a,e){var f=a.parent().parent();if(!f.hasClass("kmltree"))if(e){var n=f.parent().parent();n.hasClass("radioFolder")&&n.find(">ul>li.visible").each(function(){if(this!==f[0]){var o=$(this);E(o,false);H(o,false)}});if(!f.hasClass("visible")){E(f,true);Q(f,true)}}else if(f.find(">ul>li.visible").length===0){E(f,false);Q(f,false)}},G=function(a,e){if(!(a.hasClass("checkOffOnly")&&
e)){var f=a.parent().parent();f.hasClass("radioFolder")&&f.find(">ul>li.visible").each(function(){E($(this),false);H($(this),false)});E(a,e);e&&a.find("li.visible").length||H(a,e);Q(a,e)}},E=function(a,e){a=$(a);if(a.hasClass("visible")!==e){D(a,"visible",e);y(a).setVisibility(e);a.toggleClass("visible",e)}},D=function(a,e,f){a=a.attr("id");m[a]||(m[a]={});a=m[a];if(a[e])a[e].value=f;else a[e]={original:!f,value:f}},N=function(){for(var a in m){for(var e in m[a])m[a][e].original===m[a][e].value&&
delete m[a][e];var f=0;for(e in m[a])m[a].hasOwnProperty(e)&&f++;f===0&&delete m[a]}return m};c.getState=N;c.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var e=y(a),f=e.getLink();if(f)var n=f=f.getHref();else{var o=kmldom(e.getKml()).find("Url>href");if(o.length)n=f=o.text();else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");D(a,"open",false);return}}o=new URI(f);if(o.getAuthority()===null){var s=e.getOwnerDocument();if(s&&
s.getUrl)if(s=s.getUrl()){s=new URI(s);var u=o.resolve(s)}if(u)f=u.toString();else alert(["Could not resolve relative link in kml ","document. You may need to upgrade to the ","latest Google Earth Plugin."].join())}if(b.bustCache){u=(new Date).getTime();f=f.indexOf("?")===-1?f+"?cachebuster="+u:f+"&cachebuster="+u}a.addClass("loading");google.earth.fetchKml(g,f,function(r){if(r){g.getFeatures().appendChild(r);r.setVisibility(e.getVisibility());var v=e.getName();e.getParentNode().getFeatures().removeChild(e);
v=x(r,n,v);v=K(v.children[0].children);a.append("<ul>"+v+"</ul>");a.addClass("open");D(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");p[a.attr("id")]=r;t.push(r);$(a).attr("data-rememberedLink",M.length.toString());M.push(e);$(a).trigger("loaded",[a,r]);$(c).trigger("networklinkload",[a,r])}else{alert("Error loading "+f);a.addClass("error");$(c).trigger("kmlLoadError",[r]);a.removeClass("open")}})}};var M=[];c.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&
M.length>=a?M[a]:false};var Y=function(a){var e=new h({success:function(){},error:function(){},tree:c});e.add(a,function(f){f.addClass("open");D(f,"open",a.hasClass("open"));P(e,f)});e.execute()};q=b.element.attr("id");$("#"+q+" li > span.name").live("click",function(a){a.stopPropagation();a=$(this).parent();var e=y(a);if(a.hasClass("error")&&a.hasClass("KmlNetworkLink"))e.getLink()&&e.getLink().getHref()?alert("Could not load NetworkLink with url "+e.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");
if(a.hasClass("select"))O(a,e);else{C();if(a.hasClass("hasDescription")||e.getType()==="KmlPlacemark"){e.getType()==="KmlPlacemark"&&G(a,true);kmltreeManager.pauseListeners(function(){kmltreeManager.openBalloon(e,c)})}}$(c).trigger("click",[a[0],e])});$("#"+q+" li > span.name").live("contextmenu",function(){var a=$(this).parent(),e=y(a);$(c).trigger("contextmenu",[a[0],e])});b.element.click(function(a){if(a.target===this)C();else{a=$(a.target);a.hasClass("toggle")&&!a.hasClass("select")&&C()}});$("#"+
q+" li > .expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))Y(a);else{a.toggleClass("open");D(a,"open",a.hasClass("open"))}});$("#"+q+" li > .toggler").live("click",function(){var a=$(this).parent(),e=!a.hasClass("visible");!e&&a.hasClass("selected")&&C();!e&&g.getBalloon()&&g.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&e)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&
!a.hasClass("loading")&&!a.hasClass("loaded")){Y(a);$(a).bind("loaded",function(f,n){G(n,true);n.removeClass("open")})}else G(a,e);$(c).trigger("toggleItem",[a,e,y(a)])}});$("#"+q+" li").live("dblclick",function(a){a.stopPropagation();var e=$(a.target);a=e.parent();if(!(e.hasClass("expander")||e.hasClass("toggler")||a.hasClass("expander")||a.hasClass("toggler"))){e=$(this);var f=y(e);if(e.hasClass("error"))f.getLink()&&f.getLink().getHref()?alert("Could not load NetworkLink with url "+f.getLink().getHref()):
alert("Could not load NetworkLink. Link tag with href not found");else{G(e,true);if(f.getType()=="KmlTour")g.getTourPlayer().setTour(f);else{var n=null,o=$(b.mapElement);if(o.length)n=o.width()/o.height();b.gex.util.flyToObject(f,{boundsFallback:a.find("li").length<1E3,aspectRatio:n})}$(c).trigger("dblclick",[e,f])}}});var R=false;google.earth.addEventListener(g.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var e=a.getTarget();if(e.getType()!=="GEGlobe")if(e.getType()==="KmlPlacemark"){a=
e.getId();var f=z(a);if(f.length>=1)if(!R){R=true;setTimeout(function(){R=false;var n=$(f[0]);$(c).trigger("dblclick",[n,e])},200)}}}});c.removeEventListener=c.detachEvent=function(){};kmltreeManager.register(c,{opts:b,docs:t});return c}}(),enableGoogleLayersControl=function(){var i=function(h,j,d){if((h=h.getId())&&h.match(/^LAYER/))d.getLayerRoot().enableLayerById(d[h],j);else{var b=d.getOptions();switch(h){case "SUN":d.getSun().setVisibility(j);break;case "NAVIGATION_CONTROLS":h=d.VISIBILITY_SHOW;
if(!j)h=d.VISIBILITY_HIDE;d.getNavigationControl().setVisibility(h);break;case "STATUS_BAR":b.setStatusBarVisibility(j);break;case "OVERVIEW_MAP":b.setOverviewMapVisibility(j);break;case "SCALE_LEGEND":b.setScaleLegendVisibility(j);break;case "ATMOSPHERE":b.setAtmosphereVisibility(j);break;case "HISTORICAL_IMAGERY":d.getTime().setHistoricalImageryEnabled(j);break;case "GRID":b.setGridVisibility(j)}}};return function(h,j){if(!h||!j)alert("Must call enableGoogleLayersControl with both tree and ge options!");
$(h).bind("toggleItem",function(d,b,c,l){i(l,c,j)});$(h).bind("kmlLoaded",function(d,b){for(var c=b.getFeatures().getChildNodes(),l=c.getLength(),p=0;p<l;p++){var t=c.item(p);i(t,t.getVisibility(),j)}})}}();
