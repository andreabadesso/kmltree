var kmltreeManager=function(){that={};var j=[],g,k={};that.register=function(i,n){if(j.length===0){g=n.opts.gex.pluginInstance;google.earth.addEventListener(g,"balloonopening",b);google.earth.addEventListener(g,"balloonclose",c)}j.push({key:"kmltree-tree-"+j.length.toString(),instance:i,api:n})};that.remove=function(i){for(var n=0;n<j.length;n++)if(j[n].instance===i){j.splice(n,1);break}return i};that.pauseListeners=function(i){google.earth.removeEventListener(g,"balloonopening",b);google.earth.removeEventListener(g,
"balloonclose",c);i();google.earth.addEventListener(g,"balloonopening",b);google.earth.addEventListener(g,"balloonclose",c)};var e=function(i){for(var n=0;n<j.length;n++)if(j[n].instance===i)return j[n].api},b=function(i){var n=i.getFeature(),m=p(n);if(m){i.preventDefault();g.setBalloon(null);i=false;var s=n.getId();if(s){i=m.api.opts.selectable;if(typeof i==="function")i=i(n)}i&&m.instance.selectById(s,n);u(n,m);return false}},c=function(){$("#kmltree-balloon-iframe").remove();for(var i=0;i<j.length;i++)j[i].instance.clearSelection()},
l=function(i,n){if(i.getUrl()===n)return true;if(i.getElementByUrl(n))return true},p=function(i){i=i.getUrl();var n=i.split("#")[0];if(k[n])return k[n];for(var m=0;m<j.length;m++)if(l(j[m].instance.kmlObject,i)){k[n]=j[m];return j[m]}for(m=0;m<j.length;m++)for(var s=j[m].api.docs,D=0;D<s.length;D++)if(l(s[D],i)){k[n]=j[m];return j[m]}return false},u=function(i,n){$(window).unbind("message.kmlTreeIframeEvents");var m;n=n.instance?n.instance:n;var s=n.api?n.api:e(n);m=s.opts.displayEnhancedContent;
if(typeof m==="function")m=m(i);if(m){var D=i.getBalloonHtmlUnsafe(),z=i.getBalloonHtml();z=$.trim(z.replace(/\s*<\!--\s*Content-type: mhtml-die-die-die\s*--\>/,""));z=z!=$.trim(D)}if(m&&z){m=g.createHtmlDivBalloon("");var B=document.createElement("iframe");B.setAttribute("src",s.opts.iframeSandbox);B.setAttribute("frameBorder","0");B.setAttribute("id","kmltree-balloon-iframe");z=document.createElement("div");$(z).append(B);$(B).one("load",function(){$(window).bind("message.kmlTreeIframeEvents",{window:B.contentWindow},
function(v){var t=v.originalEvent;if(t.source===v.data.window){v=g.getBalloon();var H=v.getFeature();if(!(!$("#kmltree-balloon-iframe").length||!(t.data.match(/width/)||t.data.match(/unknownIframeDimensions/))||v.getType()!=="GEHtmlDivBalloon")){var I=p(H);t=JSON.parse(t.data);if(t.unknownIframeDimensions){t=I.api.opts.unknownIframeDimensionsDefault;if(typeof t==="function")t=t(H)}var G=$("#kmltree-balloon-iframe");v.setMinWidth(t.width);v.setMaxWidth(t.width+t.width*0.1);v.setMinHeight(t.height);
v.setMaxHeight(t.height+t.height*0.1);G.height(t.height);G.width(t.width);$(I.instance).trigger("balloonopen",[v,H])}}});this.contentWindow.postMessage(JSON.stringify({html:Base64.encode(D),callback:Base64.encode(s.opts.sandboxedBalloonCallback.toString())}),"*")});m.setContentDiv(z)}else{m=g.createFeatureBalloon("");var J=function(v){setTimeout(function(){$(n).trigger("balloonopen",[v.getBalloon(),v.getFeature()])},1);google.earth.removeEventListener(g,"balloonopening",J)};google.earth.addEventListener(g,
"balloonopening",J)}m.setFeature(i);g.setBalloon(m)};that._openBalloon=u;return that}(),Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(j){var g="",k,e,b,c,l,p,u=0;for(j=Base64._utf8_encode(j);u<j.length;){k=j.charCodeAt(u++);e=j.charCodeAt(u++);b=j.charCodeAt(u++);c=k>>2;k=(k&3)<<4|e>>4;l=(e&15)<<2|b>>6;p=b&63;if(isNaN(e))l=p=64;else if(isNaN(b))p=64;g=g+this._keyStr.charAt(c)+this._keyStr.charAt(k)+this._keyStr.charAt(l)+this._keyStr.charAt(p)}return g},
decode:function(j){var g="",k,e,b,c,l,p=0;for(j=j.replace(/[^A-Za-z0-9\+\/\=]/g,"");p<j.length;){k=this._keyStr.indexOf(j.charAt(p++));e=this._keyStr.indexOf(j.charAt(p++));c=this._keyStr.indexOf(j.charAt(p++));l=this._keyStr.indexOf(j.charAt(p++));k=k<<2|e>>4;e=(e&15)<<4|c>>2;b=(c&3)<<6|l;g+=String.fromCharCode(k);if(c!=64)g+=String.fromCharCode(e);if(l!=64)g+=String.fromCharCode(b)}return g=Base64._utf8_decode(g)},_utf8_encode:function(j){j=j.replace(/\r\n/g,"\n");for(var g="",k=0;k<j.length;k++){var e=
j.charCodeAt(k);if(e<128)g+=String.fromCharCode(e);else{if(e>127&&e<2048)g+=String.fromCharCode(e>>6|192);else{g+=String.fromCharCode(e>>12|224);g+=String.fromCharCode(e>>6&63|128)}g+=String.fromCharCode(e&63|128)}}return g},_utf8_decode:function(j){for(var g="",k=0,e=c1=c2=0;k<j.length;){e=j.charCodeAt(k);if(e<128){g+=String.fromCharCode(e);k++}else if(e>191&&e<224){c2=j.charCodeAt(k+1);g+=String.fromCharCode((e&31)<<6|c2&63);k+=2}else{c2=j.charCodeAt(k+1);c3=j.charCodeAt(k+2);g+=String.fromCharCode((e&
15)<<12|(c2&63)<<6|c3&63);k+=3}}return g}};(function(){var j={};this.tmpl=function g(k,e){var b=!/\W/.test(k)?j[k]=j[k]||g(document.getElementById(k).innerHTML):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+k.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return e?b(e):b}})();
kmldom=function(){return function(j){if(window.ActiveXObject&&window.GetObject){var g=new ActiveXObject("Microsoft.XMLDOM");g.loadXML(j);return jQuery(g)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(j,"text/xml"));throw Error("No XML parser available");}}();var URI,URIQuery;
(function(){function j(e,b){var c=/^(.*)\//;return e.authority&&!e.path?"/"+b:e.getPath().match(c)[0]+b}function g(e){if(!e)return"";e=e.replace(/\/\.\//g,"/");for(e=e.replace(/\/\.$/,"/");e.match(k);)e=e.replace(k,"/");for(e=e.replace(/\/([^\/]*)\/\.\.$/,"/");e.match(/\/\.\.\//);)e=e.replace(/\/\.\.\//,"/");return e}var k=/\/((?!\.\.\/)[^\/]*)\/\.\.\//;URI=function(e){e||(e="");e=e.match(/^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/);var b=e[1]||null,c=e[2]||null,l=
e[3]||null,p=e[4]||null,u=e[5]||null;this.getScheme=function(){return b};this.setScheme=function(i){b=i};this.getAuthority=function(){return c};this.setAuthority=function(i){c=i};this.getPath=function(){return l};this.setPath=function(i){l=i};this.getQuery=function(){return p};this.setQuery=function(i){p=i};this.getFragment=function(){return u};this.setFragment=function(i){u=i}};URI.prototype.toString=function(){var e="";if(this.getScheme())e+=this.getScheme()+":";if(this.getAuthority())e+="//"+this.getAuthority();
if(this.getPath())e+=this.getPath();if(this.getQuery())e+="?"+this.getQuery();if(this.getFragment())e+="#"+this.getFragment();return e};URI.prototype.resolve=function(e){var b=new URI;if(this.getScheme()){b.setScheme(this.getScheme());b.setAuthority(this.getAuthority());b.setPath(g(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getAuthority()){b.setAuthority(this.getAuthority());b.setPath(g(this.getPath()));b.setQuery(this.getQuery())}else{if(this.getPath()){if(this.getPath().charAt(0)===
"/")b.setPath(g(this.getPath()));else{b.setPath(j(e,this.getPath()));b.setPath(g(b.getPath()))}b.setQuery(this.getQuery())}else{b.setPath(e.getPath());this.getQuery()?b.setQuery(this.getQuery()):b.setQuery(e.getQuery())}b.setAuthority(e.getAuthority())}b.setScheme(e.getScheme())}b.setFragment(this.getFragment());return b};URI.prototype.parseQuery=function(){return URIQuery.fromString(this.getQuery(),this.querySeparator)};URIQuery=function(){this.params={};this.separator="&"};URIQuery.fromString=function(e,
b){var c=new URIQuery;if(b)c.separator=b;c.addStringParams(e);return c};URIQuery.prototype.addStringParams=function(e){e=e.split(this.separator);for(var b,c,l=0;l<e.length;l++){b=e[l].split("=",2);c=b[0].replace(/\+/g," ");b=b[1].replace(/\+/g," ");this.params.hasOwnProperty(c)||(this.params[c]=[]);this.params[c].push(b)}};URIQuery.prototype.getParam=function(e){if(this.params.hasOwnProperty(e))return this.params[e][0];return null};URIQuery.prototype.toString=function(){var e=[],b;b=this.params;var c=
[],l;for(l in b)b.hasOwnProperty(l)&&c.push(l);b=c.sort();for(c=0;c<b.length;c++)for(l=0;l<this.params[b[c]].length;l++)e.push(b[c].replace(/ /g,"+")+"="+this.params[b[c]][l].replace(/ /g,"+"));return e.join(this.separator)}})();
var kmltree=function(){function j(b){var c=document.createElement("a");c.href=b;return c.href}var g=function(b){if(b.success&&b.error&&b.tree){this.queue=[];this.opts=b}else throw"missing required option";};g.prototype.add=function(b,c){this.queue.push({node:b,callback:c,loaded:false,errors:false})};g.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var b=0;b<this.queue.length;b++){var c=this.queue[b];c.node.data("queueItem",c);if(!c.loaded&&!c.loading){var l=this;
$(c.node).bind("loaded",function(p,u,i){l.nodeLoadedCallback(p,u,i)});this.opts.tree.openNetworkLink(c.node);c.loading=true}}};g.prototype.nodeLoadedCallback=function(b,c){var l=c.data("queueItem");if(l.loaded===true)throw"event listener fired twice for "+c.find(">span.name").text();l.loaded=true;l.loading=false;$(c).unbind("loaded");l.callback(c);this.execute();this.finish(l)};g.prototype.finish=function(){for(var b=true,c=true,l=0;l<this.queue.length;l++){b=b&&this.queue[l].loaded;c=c&&!this.queue[l].errors}if(b){c?
this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};g.prototype.destroy=function(){for(var b=0;b<this.queue.length;b++)this.queue[b].node.unbind("load");this.queue=[]};var k=tmpl('<li UNSELECTABLE="on" id="<%= id %>" class="kmltree-item <%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %><% if(kmlId){ %><%= kmlId %> <% } %><% if(geoType){ %><%= geoType %><% } %>"<% if(kmlId){ %> data-id="<%= kmlId %>"<% } %>><div UNSELECTABLE="on" class="expander">&nbsp;</div><div UNSELECTABLE="on" class="toggler">&nbsp;</div><div <% if(customIcon){ %>style="background:url(<%= customIcon %>); -moz-background-size:16px 16px; -webkit-background-size:16px 16px;"<% } %>class="icon"><% if(type === "KmlNetworkLink"){ %><div class="nlSpinner">&nbsp;</div><% } %>&nbsp;</div><span UNSELECTABLE="on" class="name"><%= name %></span><% if(snippet){ %><p UNSELECTABLE="on" class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
e={visitFunction:function(b,c){return c},refreshWithState:true,bustCache:false,restoreState:false,whitelist:[],supportItemIcon:false,loadingMsg:"Loading data",setExtent:false,displayDocumentRoot:"auto",displayEnhancedContent:false,iframeSandbox:"http://underbluewaters-try-unsafe-popups.googlecode.com/hg/src/iframe.html",unknownIframeDimensionsDefault:{height:450,width:530},sandboxedBalloonCallback:function(){},selectable:function(){return false}};return function(b){var c={},l=0,p={};c.lookupTable=
p;c.kmlObject=null;var u=[];b=jQuery.extend({},e,b);var i=b.gex.pluginInstance,n=false,m={};parseFloat(i.getPluginVersion())<5.2&&alert("kmltree requires a google earth plugin version >= 5.2");if(!b.url||!b.gex||!b.element||!b.mapElement)throw"kmltree requires options url, gex, mapElement & element";b.element=$(b.element);if(!b.element.attr("id")){b.element.attr("id","kml-tree"+(new Date).getTime());b.element.attr("UNSELECTABLE","on")}b.restoreState&&$(window).unload(function(){c.destroy()});b.element.css("position")!==
"absolute"&&$(b.element).css({position:"relative"});var s=$('<div class="kmltree" style="background-size: 16px 16px; -moz-background-size: 16px 16px; -o-background-size: 16px 16px; -webkit-background-size: 16px 16px; -khtml-background-size: 16px 16px;"></div>'),D=s[0].style.backgroundSize!==undefined||s[0].style.MozBackgroundSize!==undefined||s[0].style.oBackgroundSize!==undefined||s[0].style.khtmlBackgroundSize!==undefined||s[0].style.webkitBackgroundSize!==undefined,z=function(a,d,f){var h={name:a.getName(),
id:"kml"+(f?f.replace(/\W/g,"-"):"")+d.replace(/\W/g,"-")};google.earth.executeBatch(i,function(){b.gex.dom.walk({visitCallback:function(o){var r=o.current;if(!r.children)r.children=[];var w=this.getName(),q;q=r.id;key=w?w.replace(/\W/g,"-"):"blank";q+=key;for(var x=0;p[q];){x++;q+=x}p[q]=this;var O=this.getSnippet();if(!O||O==="empty")O=false;x=this.getType();var X=false;if(x==="KmlPlacemark"){var P=this.getGeometry();if(P)X=P.getType()}var L=this.getComputedStyle(),K=b.selectable;if(typeof K===
"function")K=K(this);K=K&&this.getId();w=w||"&nbsp;";P=!!this.getVisibility();var ea=this.getOpen(),fa=this.getDescription(),A="check";if(L=L.getListStyle())switch(L.getListItemType()){case 5:A="radioFolder";break;case 2:A="checkOffOnly";break;case 3:A="checkHideChildren"}L=A;A=false;if(D&&this.getType()==="KmlPlacemark"&&this.getGeometry()&&this.getGeometry().getType()==="KmlPoint")A=this.getComputedStyle().getIconStyle().getIcon().getHref();if(b.supportItemIcon)A=(A=kmldom(this.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?
A:false;q={renderOptions:Q,name:w,visible:P,type:x,open:ea,id:q,description:fa,snippet:O,select:K,listItemType:L,customIcon:A,customClass:"",children:[],alwaysRenderNodes:false,kmlId:this.getId().replace(/\W/g,"-"),geoType:X};q=b.visitFunction(this,q);r.children.push(q);if(q.listItemType!=="checkHideChildren")o.child=q;else o.walkChildren=false},rootObject:a,rootContext:h})});return h},B=function(a){if(c.kmlObject)throw"KML already loaded";Y();var d=j(b.url);if(a||b.bustCache){a=(new Date).getTime();
d=d.indexOf("?")===-1?d+"?cachebuster="+a:d+"&cachebuster="+a}google.earth.fetchKml(i,d,function(f){n||Z(f,d,b.url)})};c.load=B;c.refresh=function(){if(b.refreshWithState)c.previousState=T();aa();p=null;p={};i.setBalloon(null);B(true)};var J=function(a){return b.element.find("."+a.replace(/\W/g,"-"))};c.getNodesById=J;c.expandParentsOf=function(a){a=$(a);for(a=a.parent().parent();!a.hasClass("kmltree")&&!a.find(">ul:visible").length;){a.addClass("open");a=a.parent().parent()}};var v=function(a,d,
f){a=J(a);if(a.length){var h=$(a[0]);I(h,d||y(h),f);return true}else if(h=H(d)){h=$(h);if(h.is(":visible")){E(true,true);h.addClass("breadcrumb");f||setTimeout(function(){$(c).trigger("select",[h,d,false])},1);return true}else{G(h);h.addClass("breadcrumb");f||setTimeout(function(){$(c).trigger("select",[parent,d,false])},1)}}else{E();return false}};c.selectById=v;var t=function(a){a=a.getParentNode();switch(a.getType()){case "KmlNetworkLink":return a;case "GEGlobe":return false;default:return t(a)}},
H=function(a,d){var f=b.element.attr("id");if(!d){d=[];$("#"+f+" li.KmlNetworkLink").each(function(){$(this).hasClass("loaded")||d.push([this,y(this)])})}f=t(a);if(f===false)return false;else{f.getLink().getHref();for(var h=0;h<d.length;h++){var o=d[h][1].getLink().getHref();if(f.getLink().getHref()===o)return d[h][0]}return H(f,d)}},I=function(a,d,f){d||(d=y(a));a=$(a);E(true,true);var h=$(a).is(":visible");M(a,true);a.addClass("selected");C(a,"selected",true);h||G(a);f||setTimeout(function(){$(c).trigger("select",
[a,d])},1)};c.selectNode=I;var G=function(a){a=$(a);a=a.parent().parent();a.addClass("breadcrumb");return a.is(":visible")?a:G(a)};c.setExpanderBreadcrumbs=G;var E=function(a,d){var f=$("#"+b.element.attr("id")).find(".selected").removeClass("selected");$(".breadcrumb").removeClass("breadcrumb");if(f.length){f.each(function(){C($(this),"selected",false)});d||setTimeout(function(){$(c).trigger("select",[null,null])},1)}i.getBalloon()&&!a&&i.setBalloon(null)};c.clearSelection=function(){return E()};
var Y=function(a){R();a=a||b.loadingMsg;a=$('<div class="kmltree-loading"><span>'+a+"</span></div>");var d=b.element.height();d!==0&&a.height(d);b.element.append(a)};c.showLoading=Y;var R=function(){b.element.find(".kmltree-loading").remove()};c.hideLoading=R;var Z=function(a,d,f){m={};if(a){l=0;c.kmlObject=a;u.push(a);c.kmlObject.setVisibility(true);var h=z(a,f),o;if(b.displayDocumentRoot===false)o=h.children[0].children;else if(b.displayDocumentRoot===true)o=h.children[0];else{o=h.children[0].children;
for(var r=0,w=false;r<o.length&&w===false;){w=o[r].type==="KmlPlacemark";r++}o=w?h.children[0]:h.children[0].children}o=Q(o);b.element.find("div.kmltree").remove();b.element.find(".kmltree-loading").before(['<div UNSELECTABLE="on" class="kmltree"><h4 UNSELECTABLE="on" class="kmltree-title">',h.children[0].name,'</h4><ul UNSELECTABLE="on" class="kmltree">',o,"</ul></div>"].join(""));i.getFeatures().appendChild(a);if(!c.previousState)if(b.restoreState&&window.localStorage)c.previousState=ga();h=new g({success:function(){R();
if(b.setExtent){var q=null,x=$(b.mapElement);if(x.length)q=x.width()/x.height();b.gex.util.flyToObject(a,{boundsFallback:true,aspectRatio:q});b.setExtent=false}$(c).trigger("kmlLoaded",[a])},error:function(){R();$(c).trigger("kmlLoadError",[a])},tree:c});c.previousState?ba(c.previousState,h):U(h,$("#"+b.element.attr("id")))}else if(l===0){l++;setTimeout(function(){jQuery.ajax({url:d,success:function(){c.load(true)},error:function(){Z(a,d,f)}})},100)}else setTimeout(function(){b.element.html(['<div class="kmltree"><h4 class="kmltree-title">Error Loading</h4><p class="error">could not load kml file. Try clicking <a target="_blank" href="',
d,'">this link</a>, then refreshing the application.<p></div>'].join(""));$(c).trigger("kmlLoadError",[a])},0)},ba=function(a,d){for(var f in a){var h=$("#"+f);if(h.length===1){for(var o in a[f]){h.toggleClass(o,a[f][o].value);C(h,o,a[f][o].value);o==="visible"&&y(h).setVisibility(a[f][o].value)}delete a[f]}}$("#"+b.element.attr("id")).find("li.KmlNetworkLink.open").each(function(){var r=$(this);!r.hasClass("checkHideChildren")&&!r.hasClass("loading")&&!r.hasClass("loaded")&&!r.hasClass("error")&&
d.add(r,function(){ba(a,d)})});d.execute()},U=function(a,d){d.find("li.KmlNetworkLink.open").each(function(){var f=$(this);if(!f.hasClass("checkHideChildren")&&!f.hasClass("loading")&&!f.hasClass("loaded")){f.removeClass("open");a.add(f,function(h){h.addClass("open");C(h,"open",f.hasClass("open"));U(a,h)})}});a.execute()},Q=function(a){if(jQuery.isArray(a)){for(var d=[],f=0;f<a.length;f++)d.push(k(jQuery.extend({},ca,a[f])));return d.join("")}else return k(jQuery.extend({},ca,a))},ca={renderOptions:Q},
ha=function(){$(".KmlNetworkLink").each(function(){var a=y($(this));a&&a.getParentNode()&&b.gex.dom.removeObject(y($(this)))})},aa=function(){ha();c.kmlObject&&c.kmlObject.getParentNode()&&b.gex.dom.removeObject(c.kmlObject);c.kmlObject=null;u=[]},ga=function(){var a=localStorage.getItem("kmltree-("+b.url+")");return a?JSON.parse(a):false};c.destroy=function(){n=true;kmltreeManager.remove(c);if(b.restoreState&&window.localStorage){var a=JSON.stringify(T());localStorage.setItem("kmltree-("+b.url+")",
a)}aa();p=null;p={};a=b.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > .expander").die();$("#kmltree-balloon-iframe").remove();b.element.html("")};var y=function(a){a=$(a);return a.length?p[a.attr("id")]:false};c.lookup=y;var N=function(a,d){if(d){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){var f=a.find(">ul>li");if(f.length){F($(f[0]),true);N($(f[0]),true)}}}else a.find(">ul>li").each(function(){var h=
$(this);if(!h.hasClass("checkOffOnly")){F(h,true);N(h,true)}})}else a.find("li").each(function(){F($(this),false)})},V=function(a,d){var f=a.parent().parent();if(!f.hasClass("kmltree"))if(d){var h=f.parent().parent();h.hasClass("radioFolder")&&h.find(">ul>li.visible").each(function(){if(this!==f[0]){var o=$(this);F(o,false);N(o,false)}});if(!f.hasClass("visible")){F(f,true);V(f,true)}}else if(f.find(">ul>li.visible").length===0){F(f,false);V(f,false)}},M=function(a,d){if(!(a.hasClass("checkOffOnly")&&
d)){var f=a.parent().parent();f.hasClass("radioFolder")&&f.find(">ul>li.visible").each(function(){F($(this),false);N($(this),false)});F(a,d);d&&a.find("li.visible").length||N(a,d);V(a,d)}},F=function(a,d){a=$(a);if(a.hasClass("visible")!==d){C(a,"visible",d);y(a).setVisibility(d);a.toggleClass("visible",d)}},C=function(a,d,f){a=a.attr("id");m[a]||(m[a]={});a=m[a];if(a[d])a[d].value=f;else a[d]={original:!f,value:f}},T=function(){for(var a in m){for(var d in m[a])m[a][d].original===m[a][d].value&&
delete m[a][d];var f=0;for(d in m[a])m[a].hasOwnProperty(d)&&f++;f===0&&delete m[a]}return m};c.getState=T;c.openNetworkLink=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var d=y(a),f=d.getLink();if(f)var h=f=f.getHref();else{var o=kmldom(d.getKml()).find("Url>href");if(o.length)h=f=o.text();else{a.addClass("error");$(a).trigger("loaded",[a,false]);a.removeClass("open");C(a,"open",false);return}}o=new URI(f);if(o.getAuthority()===null){window.nl=d;var r=d.getOwnerDocument();
if((window.doc=r)&&r.getUrl())if(r=r.getUrl()){r=new URI(r);var w=o.resolve(r)}if(w)f=w.toString();else alert(["Could not resolve relative link in kml ","document. You may need to upgrade to the ","latest Google Earth Plugin."].join())}if(b.bustCache){w=(new Date).getTime();f=f.indexOf("?")===-1?f+"?cachebuster="+w:f+"&cachebuster="+w}a.addClass("loading");google.earth.fetchKml(i,f,function(q){if(q){i.getFeatures().appendChild(q);q.setVisibility(d.getVisibility());var x=d.getName();d.getParentNode().getFeatures().removeChild(d);
x=z(q,h,x);x=Q(x.children[0].children);a.append("<ul>"+x+"</ul>");a.addClass("open");C(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");p[a.attr("id")]=q;u.push(q);$(a).attr("data-rememberedLink",S.length.toString());S.push(d);$(a).trigger("loaded",[a,q]);$(c).trigger("networklinkload",[a,q])}else{alert("Error loading "+f);a.addClass("error");$(c).trigger("kmlLoadError",[q]);a.removeClass("open")}})}};var S=[];c.getNetworkLink=function(a){return(a=$(a).attr("data-rememberedLink"))&&
S.length>=a?S[a]:false};var da=function(a,d){var f=new g({success:function(h){d&&d(a,h)},error:function(){},tree:c});f.add(a,function(h){h.addClass("open");C(h,"open",a.hasClass("open"));U(f,h)});f.execute()};s=b.element.attr("id");$("#"+s+" li > span.name").live("click",function(a){a.stopPropagation();a=$(this).parent();var d=y(a);if(a.hasClass("error")&&a.hasClass("KmlNetworkLink"))d.getLink()&&d.getLink().getHref()?alert("Could not load NetworkLink with url "+d.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");
if(a.hasClass("select"))I(a,d);else{E();if(a.hasClass("hasDescription")||d.getType()==="KmlPlacemark")d.getType()==="KmlPlacemark"&&M(a,true)}kmltreeManager.pauseListeners(function(){kmltreeManager._openBalloon(d,c)});$(c).trigger("click",[a[0],d])});$("#"+s+" li > span.name").live("contextmenu",function(){var a=$(this).parent(),d=y(a);$(c).trigger("contextmenu",[a[0],d])});b.element.click(function(a){if(a.target===this)E();else{a=$(a.target);a.hasClass("toggle")&&!a.hasClass("select")&&E()}});$("#"+
s+" li > .expander").live("click",function(){var a=$(this).parent(),d=a.hasClass("open");if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))da(a,function(f){if(f.hasClass("breadcrumb")){if(d)a.find(".selected").length&&a.addClass("breadcrumb");else a.removeClass("breadcrumb");f=i.getBalloon().getFeature();v(f.getId(),f,true)}});else{a.toggleClass("open");C(a,"open",a.hasClass("open"));if(d)a.find(".selected").length&&a.addClass("breadcrumb");else a.removeClass("breadcrumb")}});
$("#"+s+" li > .toggler").live("click",function(){var a=$(this).parent(),d=!a.hasClass("visible");!d&&a.hasClass("selected")&&E();!d&&i.getBalloon()&&i.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&d)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){da(a);$(a).bind("loaded",function(f,h){M(h,true);h.removeClass("open")})}else M(a,d);$(c).trigger("toggleItem",[a,d,y(a)])}});$("#"+s+" li").live("dblclick",function(a){a.stopPropagation();
var d=$(a.target);a=d.parent();if(!(d.hasClass("expander")||d.hasClass("toggler")||a.hasClass("expander")||a.hasClass("toggler"))){d=$(this);var f=y(d);if(d.hasClass("error"))f.getLink()&&f.getLink().getHref()?alert("Could not load NetworkLink with url "+f.getLink().getHref()):alert("Could not load NetworkLink. Link tag with href not found");else{M(d,true);if(f.getType()=="KmlTour")i.getTourPlayer().setTour(f);else{var h=null,o=$(b.mapElement);if(o.length)h=o.width()/o.height();b.gex.util.flyToObject(f,
{boundsFallback:a.find("li").length<1E3,aspectRatio:h})}$(c).trigger("dblclick",[d,f])}}});var W=false;google.earth.addEventListener(i.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var d=a.getTarget();if(d.getType()!=="GEGlobe")if(d.getType()==="KmlPlacemark"){a=d.getId();var f=J(a);if(f.length>=1)if(!W){W=true;setTimeout(function(){W=false;var h=$(f[0]);$(c).trigger("dblclick",[h,d])},200)}}}});c.removeEventListener=c.detachEvent=function(){};kmltreeManager.register(c,{opts:b,docs:u});
return c}}(),enableGoogleLayersControl=function(){var j=function(g,k,e){if((g=g.getId())&&g.match(/^LAYER/))e.getLayerRoot().enableLayerById(e[g],k);else{var b=e.getOptions();switch(g){case "SUN":e.getSun().setVisibility(k);break;case "NAVIGATION_CONTROLS":g=e.VISIBILITY_SHOW;if(!k)g=e.VISIBILITY_HIDE;e.getNavigationControl().setVisibility(g);break;case "STATUS_BAR":b.setStatusBarVisibility(k);break;case "OVERVIEW_MAP":b.setOverviewMapVisibility(k);break;case "SCALE_LEGEND":b.setScaleLegendVisibility(k);
break;case "ATMOSPHERE":b.setAtmosphereVisibility(k);break;case "HISTORICAL_IMAGERY":e.getTime().setHistoricalImageryEnabled(k);break;case "GRID":b.setGridVisibility(k)}}};return function(g,k){if(!g||!k)alert("Must call enableGoogleLayersControl with both tree and ge options!");$(g).bind("toggleItem",function(e,b,c,l){j(l,c,k)});$(g).bind("kmlLoaded",function(e,b){for(var c=b.getFeatures().getChildNodes(),l=c.getLength(),p=0;p<l;p++){var u=c.item(p);j(u,u.getVisibility(),k)}})}}();
