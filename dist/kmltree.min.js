(function(){var k={};this.tmpl=function i(l,v){l=!/\W/.test(l)?(k[l]=k[l]||i(document.getElementById(l).innerHTML)):new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+l.replace(/[\r\t\n]/g," ").split("<%").join("\t").replace(/((^|%>)[^\t]*)'/g,"$1\r").replace(/\t=(.*?)%>/g,"',$1,'").split("\t").join("');").split("%>").join("p.push('").split("\r").join("\\'")+"');}return p.join('');");return v?l(v):l}})();
kmldom=function(){return function(k){if(window.ActiveXObject&&window.GetObject){var i=new ActiveXObject("Microsoft.XMLDOM");i.loadXML(k);return jQuery(i)}if(window.DOMParser)return jQuery((new DOMParser).parseFromString(k,"text/xml"));throw new Error("No XML parser available");}}();
var openBalloon=function(k,i,l){var v=i.getBalloon();if(v){if(v.getFeature()!==k){i.setBalloon(null);setTimeout(function(){openBalloon(k,i,l)},10)}}else{k.setVisibility(true);if(l&&k.getDescription()){var c=i.createHtmlStringBalloon("");c.setFeature(k);c.setContentString(k.getDescription());i.setBalloon(c)}else{c=i.createFeatureBalloon("");c.setFeature(k);setTimeout(function(){i.setBalloon(c)},10)}}},kmltree=function(){function k(c){var e=document.createElement("a");e.href=c;return e.href}var i=function(c){if(c.success&&
c.error&&c.tree&&c.my){this.queue=[];this.opts=c}else throw"missing required option";};i.prototype.add=function(c,e){this.queue.push({node:c,callback:e,loaded:false,errors:false})};i.prototype.execute=function(){if(this.queue.length===0)this.opts.success([]);else for(var c=0;c<this.queue.length;c++){var e=this.queue[c];e.node.data("queueItem",e);if(!e.loaded&&!e.loading){var p=this;$(e.node).bind("loaded",function(q,r,E){p.nodeLoadedCallback(q,r,E)});this.opts.tree.openNetworkLink(e.node);e.loading=
true}}};i.prototype.nodeLoadedCallback=function(c,e){c=e.data("queueItem");if(c.loaded===true)throw"event listener fired twice for "+e.find(">span.name").text();c.loaded=true;c.loading=false;$(e).unbind("loaded");c.callback(e);this.finish(c)};i.prototype.finish=function(){for(var c=true,e=true,p=0;p<this.queue.length;p++){c=c&&this.queue[p].loaded;e=e&&!this.queue[p].errors}if(c){e?this.opts.success(this.queue):this.opts.error(this.queue);this.destroy()}};i.prototype.destroy=function(){for(var c=
0;c<this.queue.length;c++)this.queue[c].node.unbind("load");this.queue=[]};var l=tmpl('<li class="<%= listItemType %> <%= type %> <%= customClass %> <%= (visible ? "visible " : "") %><%= (customIcon ? "hasIcon " : "") %><%= (fireEvents ? "fireEvents " : "") %><%= (alwaysRenderNodes ? "alwaysRenderNodes " : "") %><%= (select ? "select " : "") %><%= (open ? "open " : "") %><%= (description ? "hasDescription " : "") %><%= (snippet ? "hasSnippet " : "") %><%= (customIcon ? "customIcon " : "") %>marinemap-kmltree-id-<%= id %> marinemap-kmltree-item"><span class="kmlId"><%= kmlId %></span><span class="nlDocId"></span><span class="expander"><img width="16" height="16" src="<%= trans %>" /></span><span class="toggler"><img width="16" height="16" src="<%= trans %>" /></span><span <% if(customIcon){ %>style="background:url(<%= customIcon %>);"<% } %>class="icon"><img width="16" height="16" src="<%= trans %>" /></span><span class="name"><%= name %></span><% if(snippet){ %><p class="snippet"><%= snippet %></p><% } %><% if(children.length) { %><ul><%= renderOptions(children) %></ul><% } %></li>'),
v={enableSelection:function(){return false},fireEvents:function(){return false},visitFunction:function(c,e){return e},openNetworkLinks:true,restoreStateOnRefresh:true,showTitle:true,bustCache:false,restoreState:false,supportItemIcon:false,loadingMsg:"Loading data"};return function(c){var e={},p=0,q={};e.lookupTable=q;e.kmlObject=null;var r={},E={};c=jQuery.extend({},v,c);var j=c.gex.pluginInstance;if(!c.url||!c.gex||!c.element||!c.trans)throw"kmlTree must be called with options url, gex, trans & element";
c.element.attr("id")||c.element.attr("id","kml-tree"+(new Date).getTime());c.restoreState&&$(window).unload(function(){e.destroy()});$(c.element).css({position:"relative"});var L=function(a){if(e.kmlObject)throw"KML already loaded";J();var b=k(c.url);if(a||c.bustCache){a=(new Date).getTime();b=b.indexOf("?")===-1?b+"?cachebuster="+a:b+"&cachebuster="+a}google.earth.fetchKml(j,b,function(d){K(d,b)})};e.load=L;var A=function(a){if(a){a=a.replace(/\//g,"-");return c.element.find(".marinemap-kmltree-id-"+
a)}};e.getNodesById=A;e.selectById=function(a){a=A(a)[0];return w(a,n(a))};var u=function(a,b){var d=$("#"+c.element.attr("id")).find(".selected").removeClass("selected");if(d.length){d.each(function(){t($(this),"selected",false)});b||$(e).trigger("select",[null,null])}j.getBalloon()&&!a&&j.setBalloon(null)};e.clearSelection=u;var B=function(a,b,d){if(a&&b&&d){var f=a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded");if(b.name!=="root")if(b.modified){if(b.modified.open!==undefined)if(f)d.add(a,function(o){B(o,
b,d);d.execute()});else{a.toggleClass("open",b.modified.open.current);t(a,"open",b.modified.open.current)}b.modified.visibility!==undefined&&s(a,b.modified.visibility.current);b.modified.selected!==undefined&&w(a,n(a))}if(!f)for(f=0;f<b.children.length;f++){var g=b.children[f],h=a.find(">ul>li>span.name:contains("+g.name+")").parent();if(h.length===1)B(h,g,d);else h.length>1&&h.each(function(){$(this).find(">span.name").text()===g.name&&B($(this),g,d)})}}else throw"called with invalid arguments";
},J=function(a){C();a=a||c.loadingMsg;a=$('<div class="marinemap-kmltree-loading"><span>'+a+"</span></div>");var b=c.element.height();b!==0&&a.height(b);c.element.append(a)};e.showLoading=J;var C=function(){c.element.find(".marinemap-kmltree-loading").remove()};e.hideLoading=C;var K=function(a,b){if(a){p=0;e.kmlObject=a;e.kmlObject.setVisibility(true);var d=M(a),f=D(d.children[0].children),g='<div class="marinemap-kmltree">';if(c.title)g+='<h4 class="marinemap-kmltree-title">'+d.children[0].name+
"</h4>";c.element.find("div.marinemap-kmltree").remove();c.element.find(".marinemap-kmltree-loading").before(g+'<ul class="marinemap-kmltree">'+f+"</ul></div>");j.getFeatures().appendChild(a);d=new i({success:function(){C();$(e).trigger("kmlLoaded",[a])},error:function(){C();$(e).trigger("kmlLoadError",[a])},tree:e,my:E});if(!e.previousState)if(c.restoreState&&window.localStorage)e.previousState=U();e.previousState&&e.previousState.children.length?B(c.element.find("div.marinemap-kmltree"),e.previousState,
d):N(d,$("#"+c.element.attr("id")));d.execute()}else if(p===0){p++;setTimeout(function(){jQuery.ajax({url:b,success:function(){e.load(true)},error:function(){K(a,b)}})},100)}else setTimeout(function(){var h='<div class="marinemap-kmltree">';if(c.title)h+='<h4 class="marinemap-kmltree-title">Error Loading</h4>';c.element.html(h+'<p class="error">could not load kml file. Try clicking <a target="_blank" href="'+b+'">this link</a>, then refreshing the application.</p></div>');$(e).trigger("kmlLoadError",
[a])},0)},N=function(a,b){b.find("li.KmlNetworkLink.open").each(function(){var d=$(this);t(d,"open",d.hasClass("open"));d.removeClass("open");a.add(d,function(f){t(f,"open",d.hasClass("open"));f.removeClass("open");N(a,f);a.execute()})})},M=function(a){var b=V(a),d={name:a.getName()};google.earth.executeBatch(j,function(){c.gex.dom.walk({visitCallback:function(f){var g=f.current;if(!g.children)g.children=[];var h=W(b,this),o=this.getSnippet();if(!o||o==="empty")o=false;h={renderOptions:D,name:this.getName()||
"&nbsp;",visible:!!this.getVisibility(),type:this.getType(),open:this.getOpen(),id:this.getId().replace(/\//g,"-"),description:this.getDescription(),snippet:o,select:c.enableSelection(this),fireEvents:c.fireEvents(this),listItemType:X(this),customIcon:Y(this),customClass:"",children:[],kmlId:h,trans:c.trans,alwaysRenderNodes:false};h=c.visitFunction(this,h);g.children.push(h);if(h.listItemType!=="checkHideChildren")f.child=h;else f.walkChildren=false},rootObject:a,rootContext:d})});return d},Y=function(a){if(!c.supportItemIcon)return false;
return(a=kmldom(a.getKml()).find("kml>Folder, kml>Document, kml>Placemark, kml>NetworkLink").find(">Style>ListStyle>ItemIcon>href").text())?a:false},X=function(a){var b="check";if((a=a.getStyleSelector())&&a.getType()==="KmlStyle")if(a=a.getListStyle())switch(a.getListItemType()){case 0:break;case 5:b="radioFolder";break;case 2:b="checkOffOnly";break;case 3:b="checkHideChildren";break}return b},D=function(a){if(jQuery.isArray(a)){for(var b=[],d=0;d<a.length;d++)b.push(O(a[d]));return b.join("")}else return O(a)},
Z={renderOptions:D},O=function(a){return l(jQuery.extend({},Z,a))},P=function(){q=null;q={}};e.refresh=function(){if(c.restoreStateOnRefresh)e.previousState=F();P();Q();R();j.setBalloon(null);L(true)};var R=function(){for(var a in r){var b=r[a];b&&b.getParentNode()&&c.gex.dom.removeObject(b)}r={}},Q=function(){R();e.kmlObject&&e.kmlObject.getParentNode()&&c.gex.dom.removeObject(e.kmlObject);e.kmlObject=null},U=function(){var a=localStorage.getItem("marinemap-kmltree-("+c.url+")");return a?JSON.parse(a):
false},aa=function(){var a=JSON.stringify(F());localStorage.setItem("marinemap-kmltree-("+c.url+")",a)};e.destroy=function(){c.restoreState&&window.localStorage&&aa();P();Q();var a=c.element.attr("id");$("#"+a+" li > span.name").die();$("#"+a+" li").die();$("#"+a+" li > span.expander").die();c.element.html("")};var n=function(a){a=$(a);if(a.length&&a.find("> .kmlId").length){var b=$($(a)[0]).find("> .kmlId").text().split("-");a=b[0];b=parseInt(b[1]);return q[a][b]}else return false};e.lookup=n;var W=
function(a,b){q[a].push(b);return a+"-"+(q[a].length-1)},S=function(a){a=$(a);return a.length&&a.find("> .nlDocId").length?r[a.find("> .nlDocId").text()]:false},V=function(a){var b=a.getName()+(new Date).getTime();if(q[b])throw"document already added to lookup";r[b]=a;q[b]=[];return b},w=function(a,b){b||(b=n(a));a=$(a);u(true,true);a.addClass("selected");x(a,true);a.addClass("selected");openBalloon(b,j);for(var d=a.parent().parent();!d.hasClass("marinemap-kmltree")&&!d.find(">ul:visible").length;){d.addClass("open");
d=d.parent().parent()}t(a,"selected",true);$(e).trigger("select",[a,b])};e.selectNode=w;var y=function(a,b){if(b){if(!a.hasClass("checkOffOnly"))if(a.hasClass("radioFolder")){if(!a.find(">ul>li.visible").length){a=a.find(">ul>li");if(a.length){s($(a[0]),true);y($(a[0]),true)}}}else a.find(">ul>li").each(function(){var d=$(this);if(!d.hasClass("checkOffOnly")){s(d,true);y(d,true)}})}else a.find("li").each(function(){s($(this),false)})},G=function(a,b){var d=a.parent().parent();if(!d.hasClass("marinemap-kmltree"))if(b){a=
d.parent().parent();a.hasClass("radioFolder")&&a.find(">ul>li.visible").each(function(){if(this!==d[0]){var f=$(this);s(f,false);y(f,false)}});if(!d.hasClass("visible")){s(d,true);G(d,true)}}else if(d.find(">ul>li.visible").length===0){s(d,false);G(d,false)}},x=function(a,b){if(!(a.hasClass("checkOffOnly")&&b)){var d=a.parent().parent();d.hasClass("radioFolder")&&d.find(">ul>li.visible").each(function(){s($(this),false);y($(this),false)});s(a,b);y(a,b);G(a,b)}},s=function(a,b){a=$(a);if(a.hasClass("visible")!==
b){t(a,"visibility",b);n(a).setVisibility(b);a.toggleClass("visible",b);a.hasClass("KmlNetworkLink")&&a.hasClass("loaded")&&S(a).setVisibility(b)}},t=function(a,b,d){var f=a.data("modified");f||(f={});if(!f[b]){f[b]={};f[b].original=b==="open"?n(a).getOpen():b==="visibility"?n(a).getVisibility():!d}f[b].current=d;a.data("modified",f)},F=function(){c.element.find("span.name:contains(asdf)").parent().find("ul span.name:contains(asdf)").parent();var a={name:"root",remove:false,children:[],parent:false};
T(function(d,f){var g={name:d.find(">span.name").text(),remove:true,children:[],parent:f};d=d.data("modified");var h={},o=false;for(var m in d)if(d[m].current!==d[m].original){h[m]=d[m];o=m}if(o){g.modified=h;g.remove=false;for(m=f;m.parent;){m.remove=false;m=m.parent}}f.children.push(g);return g},a);var b=function(d){if(d.remove===true)return false;else{for(var f=[],g=0;g<d.children.length;g++){var h=b(d.children[g]);if(h){delete h.remove;delete h.parent;f.push(h)}}d.children=f;return d}};return b(a)};
e.getState=F;var ba=function(a){for(var b in r)if(r[b]===a)return b;throw"could not getDocId";},H=function(a){if(a.find("> ul").length)throw"networklink already loaded";else{var b=n(a),d=b.getLink().getHref();if(c.bustCache){var f=(new Date).getTime();d=d.indexOf("?")===-1?d+"?cachebuster="+f:d+"&cachebuster="+f}a.addClass("loading");google.earth.fetchKml(j,d,function(g){if(g){j.getFeatures().appendChild(g);g.setVisibility(b.getVisibility());b.getParentNode().getFeatures().removeChild(b);var h=M(g);
h=D(h.children[0].children);a.append("<ul>"+h+"</ul>");a.addClass("open");t(a,"open",a.hasClass("open"));a.removeClass("loading");a.addClass("loaded");a.find(".nlDocId").text(ba(g));$(a).trigger("loaded",[a,g]);$(e).trigger("networklinkload",[a,g])}else{a.addClass("error");a.addClass("checkHideChildren");$(e).trigger("kmlLoadError",[g])}})}};e.openNetworkLink=H;var T=function(a,b,d){var f=function(g,h){g.find(">ul>li").each(function(){var o=$(this),m=a(o,h);if(m===false)return true;else f(o,m)})};
d||(d=c.element.find("div.marinemap-kmltree"));f(d,b)};e.walk=T;var z=c.element.attr("id");$("#"+z+" li > span.name").live("click",function(){var a=$(this).parent(),b=n(a);a.hasClass("error")&&a.hasClass("KmlNetworkLink")&&alert("There was an error loading this NetworkLink. "+b.getLink().getHref());if(a.hasClass("select"))w(a,b);else{u();if(a.hasClass("hasDescription")){x(a,true);openBalloon(b,j,c.whiteListed)}}a.hasClass("fireEvents")&&$(e).trigger("click",[a[0],b])});$("#"+z+" li.fireEvents > span.name").live("contextmenu",
function(){var a=$(this).parent(),b=n(a);a.hasClass("fireEvents")&&$(e).trigger("contextmenu",[a[0],b])});c.element.click(function(a){if(a.target===this)u();else $(a.target).hasClass("toggle")&&!$(a.target).hasClass("select")&&u()});$("#"+z+" li > span.expander").live("click",function(){var a=$(this).parent();if(a.hasClass("KmlNetworkLink")&&!a.hasClass("loaded")&&!a.hasClass("loading"))H(a);else{a.toggleClass("open");t(a,"open",a.hasClass("open"))}});$("#"+z+" li > span.toggler").live("click",function(){var a=
$(this).parent(),b=!a.hasClass("visible");!b&&a.hasClass("selected")&&u();!b&&j.getBalloon()&&j.setBalloon(null);if(!(a.hasClass("checkOffOnly")&&b)){if(a.hasClass("KmlNetworkLink")&&a.hasClass("alwaysRenderNodes")&&!a.hasClass("open")&&!a.hasClass("loading")&&!a.hasClass("loaded")){H(a);$(a).bind("loaded",function(d,f){x(f,true);f.removeClass("open")})}else x(a,b);a.hasClass("fireEvents")&&$(e).trigger("toggleItem",[a,b])}});$("#"+z+" li").live("dblclick",function(a){a=$(a.target);var b=a.parent();
if(!(a.hasClass("expander")||a.hasClass("toggler")||b.hasClass("expander")||b.hasClass("toggler"))){a=$(this);b=n(a);x(a,true);if(b.getType()=="KmlTour")j.getTourPlayer().setTour(b);else{var d=null;if(c.map_div)d=$(c.map_div).width()/$(c.map_div).height();b.getType()==="KmlNetworkLink"&&a.hasClass("loaded")?c.gex.util.flyToObject(S(a),{boundsFallback:true,aspectRatio:d}):c.gex.util.flyToObject(b,{boundsFallback:true,aspectRatio:d})}a.hasClass("fireEvents")&&$(e).trigger("dblclick",[a,b])}});google.earth.addEventListener(j.getGlobe(),
"click",function(a){if(a.getButton()!==-1){a=a.getTarget();var b=j.getBalloon();if(a.getType()==="GEGlobe"&&!b)u();else if(a.getType()==="KmlPlacemark"){a=a.getId();a=A(a);a.length>=1?w(a[0],n(a[0])):u()}}});var I=false;google.earth.addEventListener(j.getGlobe(),"dblclick",function(a){if(a.getButton()!==-1){var b=a.getTarget();if(b.getType()!=="GEGlobe")if(b.getType()==="KmlPlacemark"){a=b.getId();var d=A(a);if(d.length>=1)if(!I){I=true;setTimeout(function(){I=false;$(e).trigger("dblclick",[$(d[0]),
b])},200)}}}});return e}}();
